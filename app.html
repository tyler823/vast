<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="data:image/png;base64,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" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VAST Platform</title>
  <!-- Memberstack webflow package -->
  <script data-memberstack-app="app_cmm3lt2s8006c0ss17f1u2kyk" src="https://static.memberstack.com/scripts/v2/memberstack.js" type="text/javascript"></script>
  <script>
    // Gate: redirect to marketing page if not an active member
    document.addEventListener("DOMContentLoaded", function() {
      var check = setInterval(function() {
        if (!window.$memberstackDom) return;
        clearInterval(check);
        window.$memberstackDom.getCurrentMember().then(function(res) {
          if (!res || !res.data) {
            window.location.href = "/index.html";
          }
        }).catch(function() {
          window.location.href = "/index.html";
        });
      }, 100);
    });
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #080808; color: #f0f0f0; font-family: 'Barlow', sans-serif; transition: background 0.2s, color 0.2s; }
    #root { min-height: 100vh; }
    #vast-loading {
      position: fixed; inset: 0; background: #080808;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 9999; transition: opacity 0.4s;
    }
    #vast-loading img { height: 56px; width: auto; }
    #vast-loading p { margin-top: 16px; color: #555; font-size: 14px; font-family: 'Barlow', sans-serif; letter-spacing: 1px; }
  </style>
</head>
<body>
  <script>
    // Apply saved theme to body immediately to avoid flash
    (function() {
      var t = localStorage.getItem("vast-theme") || "dark";
      document.documentElement.style.background = t === "light" ? "#f4f4f5" : "#080808";
      document.body && (document.body.style.background = t === "light" ? "#f4f4f5" : "#080808");
    })();
  </script>
  <div id="vast-loading">
    <img src="data:image/jpeg;base64,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" alt="VAST" />
    <p>Loading platform...</p>
  </div>
  <div id="root"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js" crossorigin></script>

  <script type="text/babel" data-presets="react">
const { useState, useEffect, useRef, useCallback } = React;

// ─── VAST Color Palettes ─────────────────────────────────────────────
const DARK_THEME = {
  bg: "#080808", surface: "#111111", surface2: "#1a1a1a", surface3: "#222222",
  border: "#2a2a2a", red: "#E63329", redDark: "#b82820", redGlow: "rgba(230,51,41,0.15)",
  text: "#f0f0f0", textMuted: "#888", textDim: "#555",
  green: "#22c55e", yellow: "#eab308", blue: "#3b82f6",
  isDark: true,
};
const LIGHT_THEME = {
  bg: "#f4f4f5", surface: "#ffffff", surface2: "#f0f0f1", surface3: "#e4e4e7",
  border: "#d4d4d8", red: "#E63329", redDark: "#b82820", redGlow: "rgba(230,51,41,0.1)",
  text: "#18181b", textMuted: "#71717a", textDim: "#a1a1aa",
  green: "#16a34a", yellow: "#ca8a04", blue: "#2563eb",
  isDark: false,
};

// C is a mutable reference — VASTApp reassigns before each render based on theme
let C = DARK_THEME;

// ─── Injected Styles (function so they regenerate with theme) ─────────
const makeSTYLE = (C) => `
  @import url('https://fonts.googleapis.com/css2?family=Barlow:wght@300;400;500;600;700&family=Barlow+Condensed:wght@600;700;800&display=swap');
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:${C.bg};color:${C.text};font-family:'Barlow',sans-serif;min-height:100vh}
  ::-webkit-scrollbar{width:4px;height:4px}
  ::-webkit-scrollbar-track{background:${C.surface}}
  ::-webkit-scrollbar-thumb{background:${C.border};border-radius:2px}
  input,textarea,select{background:${C.surface2};border:1px solid ${C.border};color:${C.text};font-family:'Barlow',sans-serif;border-radius:6px;padding:10px 14px;width:100%;font-size:14px;outline:none;transition:border 0.2s}
  input:focus,textarea:focus,select:focus{border-color:${C.red}}
  textarea{resize:vertical;min-height:80px}
  select option{background:${C.surface2}}
  button{cursor:pointer;font-family:'Barlow',sans-serif;font-weight:600;border:none;border-radius:6px;transition:all 0.2s}
  .btn-primary{background:${C.red};color:#fff;padding:10px 20px;font-size:14px}
  .btn-primary:hover{background:${C.redDark};transform:translateY(-1px)}
  .btn-secondary{background:${C.surface2};color:${C.text};padding:10px 20px;font-size:14px;border:1px solid ${C.border}}
  .btn-secondary:hover{border-color:${C.red};color:${C.red}}
  .btn-ghost{background:transparent;color:${C.textMuted};padding:8px 14px;font-size:13px}
  .btn-ghost:hover{color:${C.text};background:${C.surface2}}
  .btn-danger{background:rgba(230,51,41,0.15);color:${C.red};padding:8px 14px;font-size:13px;border:1px solid rgba(230,51,41,0.3)}
  .btn-danger:hover{background:${C.red};color:#fff}
  .card{background:${C.surface};border:1px solid ${C.border};border-radius:10px;padding:20px}
  .label{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:${C.textMuted};margin-bottom:6px;display:block}
  h1,h2,h3,h4{font-family:'Barlow Condensed',sans-serif;letter-spacing:0.5px}
  .tag-on{background:rgba(34,197,94,0.15);color:${C.green};border:1px solid rgba(34,197,94,0.3);padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700}
  .tag-off{background:rgba(230,51,41,0.15);color:${C.red};border:1px solid rgba(230,51,41,0.3);padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700}
  .tag-done{background:rgba(34,197,94,0.15);color:${C.green};border:1px solid rgba(34,197,94,0.3);padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700}
  .sidebar-link{display:flex;align-items:center;gap:10px;padding:10px 16px;border-radius:8px;color:${C.textMuted};font-size:14px;font-weight:500;cursor:pointer;transition:all 0.15s;text-decoration:none;border:none;background:none;width:100%;text-align:left}
  .sidebar-link:hover{background:${C.surface2};color:${C.text}}
  .sidebar-link.active{background:${C.redGlow};color:${C.red};border-left:3px solid ${C.red};padding-left:13px}
  .divider{height:1px;background:${C.border};margin:12px 0}
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:100;display:flex;align-items:center;justify-content:center;padding:20px}
  .modal{background:${C.surface};border:1px solid ${C.border};border-radius:12px;padding:28px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;box-sizing:border-box}
  .field{margin-bottom:16px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .fade-in{animation:fadeIn 0.3s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .progress-bar{height:6px;background:${C.surface2};border-radius:3px;overflow:hidden}
  .progress-fill{height:100%;background:${C.red};border-radius:3px;transition:width 0.5s}
  .rating-btn{width:44px;height:44px;border-radius:8px;border:1px solid ${C.border};background:${C.surface2};color:${C.textMuted};font-size:15px;font-weight:700;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center}
  .rating-btn:hover,.rating-btn.sel{background:${C.red};border-color:${C.red};color:#fff}
  .huddle-item{padding:16px;border-radius:8px;border:1px solid ${C.border};background:${C.surface};margin-bottom:8px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all 0.2s}
  .huddle-item.active{border-color:${C.red};background:${C.redGlow}}
  .huddle-item.done{opacity:0.5}
  .timer-display{font-family:'Barlow Condensed',sans-serif;font-size:52px;font-weight:700;color:${C.red};letter-spacing:2px}
  .badge{display:inline-flex;align-items:center;justify-content:center;min-width:20px;height:20px;background:${C.red};color:#fff;border-radius:10px;font-size:10px;font-weight:700;padding:0 6px}
  .checkbox{width:18px;height:18px;border-radius:4px;border:2px solid ${C.border};cursor:pointer;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s}
  .checkbox.checked{background:${C.green};border-color:${C.green};color:#fff}
  /* ── Mobile ── */
  @media(max-width:768px){
    .grid2{grid-template-columns:1fr!important}
    .grid3{grid-template-columns:1fr!important}
    .card{padding:14px!important}
    .modal{padding:20px!important;max-height:85vh!important}
    .timer-display{font-size:36px!important}
    .mob-stack{flex-direction:column!important}
    .mob-hide{display:none!important}
    .mob-full{width:100%!important}
  }
  .stat-card{background:${C.surface};border:1px solid ${C.border};border-radius:10px;padding:20px;text-align:center}
  .vast-logo-text{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;letter-spacing:2px;color:#fff}
  .vast-logo-mark{color:${C.red};font-size:22px;margin-left:2px}
  .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
  .empty-state{text-align:center;padding:48px;color:${C.textMuted}}
  .empty-state svg{opacity:0.3;margin-bottom:12px}
  .row{display:flex;align-items:center;gap:12px}
  .row-between{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:${C.surface2};border:1px solid ${C.border};border-radius:20px;padding:4px 12px;font-size:12px;color:${C.textMuted}}
  .table{width:100%;border-collapse:collapse}
  .table th{text-align:left;padding:10px 12px;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:${C.textMuted};border-bottom:1px solid ${C.border}}
  .table td{padding:12px;font-size:14px;border-bottom:1px solid ${C.surface2}}
  .table tr:last-child td{border-bottom:none}
  .table tr:hover td{background:${C.surface2}}
  .priority-1{color:${C.red};font-weight:700}
  .priority-2{color:${C.yellow};font-weight:700}
  .priority-3{color:${C.blue};font-weight:700}
`;

// ─── Helpers ─────────────────────────────────────────────────────────
const uid = () => Math.random().toString(36).slice(2, 9);
const now = () => new Date().toISOString();
const dateStr = (d = new Date()) => d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
// Normalize todo assignees — supports both old string and new array format
const getAssignees = (t) => t.assignees ? t.assignees : (t.assignee ? [t.assignee] : []);
const weekKey = () => weekKeyFromDate(new Date());
const weekKeyFromDate = (d) => {
  const startOfYear = new Date(d.getFullYear(), 0, 1);
  const week = Math.ceil(((d - startOfYear) / 86400000 + startOfYear.getDay() + 1) / 7);
  return `${d.getFullYear()}-W${String(week).padStart(2,"0")}`;
};
const weekLabel = (key) => {
  // Parse YYYY-Www back to a readable "Mon DD" label for the week's Monday
  const [yr, wPart] = key.split("-W");
  const weekNum = parseInt(wPart, 10);
  const jan1 = new Date(parseInt(yr, 10), 0, 1);
  const daysOffset = (weekNum - 1) * 7 - jan1.getDay() + 1;
  const monday = new Date(jan1);
  monday.setDate(jan1.getDate() + daysOffset);
  return monday.toLocaleDateString("en-US", { month: "short", day: "numeric" });
};
// Generate week keys from a start date to an end date (inclusive)
const weeksInRange = (startDate, endDate) => {
  const keys = [];
  const cur = new Date(startDate);
  cur.setHours(0,0,0,0);
  // Snap to Monday of that week
  cur.setDate(cur.getDate() - ((cur.getDay() + 6) % 7));
  const end = new Date(endDate);
  end.setHours(23,59,59,999);
  while (cur <= end) {
    keys.push(weekKeyFromDate(cur));
    cur.setDate(cur.getDate() + 7);
  }
  return keys;
};

// ─── Storage Helpers (Memberstack cloud) ─────────────────────────────

// Wait for Memberstack SDK AND confirmed authenticated session
function waitForMemberstack(timeout = 10000) {
  return new Promise((resolve, reject) => {
    const start = Date.now();
    const check = setInterval(async () => {
      if (Date.now() - start > timeout) {
        clearInterval(check);
        reject(new Error("Memberstack session timeout"));
        return;
      }
      const ms = window.$memberstackDom;
      if (!ms) return;
      try {
        const res = await ms.getCurrentMember();
        if (res && res.data) { clearInterval(check); resolve(ms); }
      } catch {}
    }, 150);
  });
}

// Sync status indicator (shown in sidebar footer area)
let _syncStatus = "idle"; // "idle" | "saving" | "saved" | "error"
function setSyncStatus(s) {
  _syncStatus = s;
  const el = document.getElementById("vast-sync-status");
  if (!el) return;
  const map = { idle: "", saving: "⏳ Syncing...", saved: "✓ Saved to cloud", error: "⚠ Sync failed" };
  const col = { idle: "", saving: "#888", saved: "#22c55e", error: "#E63329" };
  el.textContent = map[s] || "";
  el.style.color = col[s] || "";
}

async function loadCompany() {
  // Retry up to 3 times — on a fresh login the session token can take a moment
  for (let attempt = 1; attempt <= 3; attempt++) {
    try {
      const ms = await waitForMemberstack();
      const res = await ms.getMemberJSON();
      console.log(`[VAST] getMemberJSON attempt ${attempt}:`, JSON.stringify(res).slice(0, 200));

      const cloud = res?.data?.vastData;
      if (cloud && typeof cloud === "object" && (cloud.name || cloud.members || cloud.huddles)) {
        try { localStorage.setItem("vast:cloud-cache", JSON.stringify(cloud)); } catch {}
        console.log("[VAST] Loaded from Memberstack cloud.");
        return cloud;
      }

      if (attempt < 3) {
        console.log(`[VAST] No data yet on attempt ${attempt}, retrying in 1s...`);
        await new Promise(r => setTimeout(r, 1000));
      }
    } catch(e) {
      console.warn(`[VAST] getMemberJSON attempt ${attempt} failed:`, e);
      if (attempt < 3) await new Promise(r => setTimeout(r, 1000));
    }
  }

  // Fallback: local cache
  try {
    const cached = localStorage.getItem("vast:cloud-cache");
    if (cached) { console.log("[VAST] Loaded from local cache fallback."); return JSON.parse(cached); }
  } catch {}
  return null;
}

let _saveTimer = null;
let _pendingData = null;

function saveCompany(data) {
  _pendingData = data;
  try { localStorage.setItem("vast:cloud-cache", JSON.stringify(data)); } catch {}
  setSyncStatus("saving");
  if (_saveTimer) clearTimeout(_saveTimer);
  _saveTimer = setTimeout(() => flushSave(), 800);
}

async function flushSave() {
  if (!_pendingData) return;
  const data = _pendingData;
  try {
    const ms = await waitForMemberstack(5000);
    await ms.updateMemberJSON({ json: { vastData: data } });
    console.log("[VAST] Saved to Memberstack cloud successfully.");
    setSyncStatus("saved");
    setTimeout(() => setSyncStatus("idle"), 3000);
    _pendingData = null;
  } catch(e) {
    console.error("[VAST] Memberstack save failed:", e);
    setSyncStatus("error");
  }
}

// Flush on tab close
window.addEventListener("beforeunload", () => {
  if (_saveTimer) clearTimeout(_saveTimer);
  if (_pendingData) {
    try {
      const ms = window.$memberstackDom;
      if (ms) ms.updateMemberJSON({ json: { vastData: _pendingData } });
    } catch {}
  }
});

// One-time migration: move old localStorage data to cloud
async function migrateLocalStorageToCloud() {
  try {
    const oldKeys = Object.keys(localStorage).filter(k => k.startsWith("vast:company:"));
    if (oldKeys.length === 0) return null;
    const old = localStorage.getItem(oldKeys[0]);
    if (!old) return null;
    const parsed = JSON.parse(old);
    console.log("[VAST] Migrating old localStorage data to cloud...");
    const ms = await waitForMemberstack();
    await ms.updateMemberJSON({ json: { vastData: parsed } });
    localStorage.removeItem(oldKeys[0]);
    console.log("[VAST] Migration complete.");
    return parsed;
  } catch(e) { console.warn("[VAST] Migration failed:", e); return null; }
}

// ─── Default Company Data ─────────────────────────────────────────────
function defaultCompany(name, code) {
  return {
    name, code,
    members: [],
    navigator: {
      coreValues: ["", "", ""],
      purpose: "", avenue: "", targetMarket: "",
      different: "", proof: "", promise: "",
      futureDate: "", revenue: "", profit: "", whatLooksLike: "",
      majorMotivator: ""
    },
    orgChart: {
      dreamer: "", doer: "",
      salesRoles: [{ role: "Sales/Mktg", members: [""] }],
      opsRoles: [{ role: "Operations", members: [""] }],
      financeRoles: [{ role: "Finance", members: [""] }],
    },
    quarterlyTasks: [],
    individualTasks: {},
    scorecard: { measurables: [], entries: {} },
    huddles: [{ id: "huddle-1", name: "Weekly Huddle" }],
    navigators: [{ id: "nav-1", name: "Navigator", coreValues: ["","",""], purpose: "", avenue: "", targetMarket: "", different: "", proof: "", promise: "", futureDate: "", revenue: "", profit: "", whatLooksLike: "", majorMotivator: "" }],
    orgCharts: [{ id: "org-1", name: "Responsibility Chart", dreamer: "", doer: "", salesRoles: [{ role: "Sales/Mktg", members: [""] }], opsRoles: [{ role: "Operations", members: [""] }], financeRoles: [{ role: "Finance", members: [""] }] }],
    meetings: [],
    issues: [],
    headlines: [],
    todos: [],
    currentQuarter: `Q${Math.ceil((new Date().getMonth() + 1) / 3)} ${new Date().getFullYear()}`,
    quarterStart: new Date().toISOString().slice(0, 10),
    quarterEnd: new Date(Date.now() + 90 * 86400000).toISOString().slice(0, 10),
    yearGoal: { futureDate: "", revenue: "", profit: "", goals: ["", "", "", "", ""] },
    annualGoals: [{ id: "goal-1", name: "Annual Goal", futureDate: "", revenue: "", profit: "" }],
    problemQueue: [],
    quarterHistory: []
  };
}

// ─── Icons ───────────────────────────────────────────────────────────
const Icon = {
  dashboard: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
  navigator: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>,
  huddle: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
  tasks: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,
  scorecard: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
  issues: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
  org: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="7" width="6" height="4"/><rect x="9" y="15" width="6" height="4"/><rect x="16" y="7" width="6" height="4"/><line x1="5" y1="11" x2="5" y2="15"/><line x1="19" y1="11" x2="19" y2="15"/><line x1="12" y1="15" x2="12" y2="11"/><line x1="5" y1="15" x2="19" y2="15"/></svg>,
  history: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><polyline points="12 7 12 12 15 15"/></svg>,
  settings: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
  plus: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  trash: () => <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
  edit: () => <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
  chevron: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 18 15 12 9 6"/></svg>,
  check: () => <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
  logout: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
  archive: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>,
  headlines: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
};

// ─── Logo Component ───────────────────────────────────────────────────
const VAST_LOGO_B64 = "data:image/jpeg;base64,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";

function VASTLogo({ size = "md" }) {
  const sizes = {
    lg: { h: 52, fs: 48 },
    md: { h: 40, fs: 37 },
    sm: { h: 26, fs: 24 },
  };
  const s = sizes[size] || sizes.md;
  const textColor = C.isDark ? "#ffffff" : "#18181b";
  return (
    <svg height={s.h} viewBox={`0 0 ${s.fs * 2.9} ${s.h}`} fill="none" xmlns="http://www.w3.org/2000/svg" style={{ display: "block" }}>
      <text
        x="0" y={s.h - 4}
        fontFamily="'Barlow Condensed', 'Barlow', Arial Narrow, sans-serif"
        fontWeight="800"
        fontSize={s.fs}
        letterSpacing="2"
        fill={textColor}
      >VAST</text>
    </svg>
  );
}

// ─── MOBILE HOOK ─────────────────────────────────────────────────────
function useMobile() {
  const [mobile, setMobile] = React.useState(() => window.innerWidth <= 640);
  React.useEffect(() => {
    const fn = () => setMobile(window.innerWidth <= 640);
    window.addEventListener("resize", fn);
    return () => window.removeEventListener("resize", fn);
  }, []);
  return mobile;
}

// ─── SIDEBAR ──────────────────────────────────────────────────────────
function Sidebar({ view, setView, company, theme, toggleTheme, mobileOpen, setMobileOpen, collapsed, setCollapsed }) {
  const openIssues = company.issues?.filter(i => i.status !== "resolved").length || 0;
  const pendingTodos = company.todos?.filter(t => !t.done).length || 0;
  const huddles = company.huddles || [{ id: "huddle-1", name: "Weekly Huddle" }];
  const navigators = company.navigators || [{ id: "nav-1", name: "Navigator" }];
  const orgCharts = company.orgCharts || [{ id: "org-1", name: "Responsibility Chart" }];
  const isMobile = useMobile();
  const w = collapsed && !isMobile ? 56 : 220;

  const SectionLabel = ({ label }) => collapsed && !isMobile ? null : (
    <div style={{ padding: "8px 16px 4px", fontSize: 10, fontWeight: 700, letterSpacing: 1.5, textTransform: "uppercase", color: C.textMuted, marginTop: 6 }}>{label}</div>
  );

  const Link = ({ id, icon: Ico, label, badge }) => (
    <button
      className={`sidebar-link ${view === id ? "active" : ""}`}
      onClick={() => setView(id)}
      title={collapsed && !isMobile ? label : undefined}
      style={{ justifyContent: collapsed && !isMobile ? "center" : undefined, padding: collapsed && !isMobile ? "9px 0" : undefined }}
    >
      <Ico />
      {!(collapsed && !isMobile) && <span style={{ flex: 1, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{label}</span>}
      {!(collapsed && !isMobile) && badge > 0 && <span className="badge">{badge}</span>}
      {(collapsed && !isMobile) && badge > 0 && (
        <span style={{ position: "absolute", top: 4, right: 4, background: C.red, color: "#fff", borderRadius: "50%", fontSize: 9, width: 14, height: 14, display: "flex", alignItems: "center", justifyContent: "center", fontWeight: 700 }}>{badge}</span>
      )}
    </button>
  );

  const navItems = (
    <>
      <Link id="dashboard" icon={Icon.dashboard} label="Dashboard" />
      <SectionLabel label="Navigators" />
      {navigators.map(n => <Link key={n.id} id={"navigator:" + n.id} icon={Icon.navigator} label={n.name} />)}
      <SectionLabel label="Huddles" />
      {huddles.map(h => <Link key={h.id} id={"huddle:" + h.id} icon={Icon.huddle} label={h.name} />)}
      <SectionLabel label="Org Charts" />
      {orgCharts.map(o => <Link key={o.id} id={"orgchart:" + o.id} icon={Icon.org} label={o.name} />)}
      <div style={{ borderTop: `1px solid ${C.border}`, marginTop: 8, paddingTop: 8 }} />
      <Link id="tasks" icon={Icon.tasks} label="Quarterly Tasks" />
      <Link id="scorecard" icon={Icon.scorecard} label="Scorecard" />
      <Link id="headlines" icon={Icon.headlines} label="Headlines" />
      <Link id="issues" icon={Icon.issues} label="Issues" badge={openIssues} />
      <Link id="todos" icon={Icon.tasks} label="To-Dos" badge={pendingTodos} />
      <Link id="history" icon={Icon.history} label="Meeting History" />
      <Link id="quarterhistory" icon={Icon.archive} label="Historical Quarters" />
      <Link id="settings" icon={Icon.settings} label="Settings" />
    </>
  );

  const footer = (
    <div style={{ padding: collapsed && !isMobile ? "12px 4px" : "12px 8px", borderTop: `1px solid ${C.border}`, flexShrink: 0 }}>
      {!(collapsed && !isMobile) && (
        <button
          onClick={() => { window.location.href = "mailto:info@job-dox.com?subject=VAST%20Coaching%20Program%20-%20Application&body=Hi%20there%2C%0A%0AI%27m%20interested%20in%20applying%20for%20the%20VAST%20Coaching%20Program.%0A%0AMy%20name%3A%0AMy%20business%3A%0AMy%20trade%20%2F%20industry%3A%0ANumber%20of%20employees%3A%0ABest%20number%20to%20reach%20me%3A%0A%0AA%20little%20about%20what%20I%27m%20hoping%20to%20accomplish%3A%0A%0ALooking%20forward%20to%20connecting!"; }}
          style={{
            display: "flex", alignItems: "center", gap: 8, width: "100%",
            background: C.red, color: "#fff", border: "none", cursor: "pointer",
            borderRadius: 8, padding: "9px 12px", marginBottom: 8,
            fontSize: 13, fontWeight: 700, letterSpacing: "0.01em", lineHeight: 1.2
          }}
        >
          <span style={{ fontSize: 15 }}>&#x1F680;</span>
          <span>Apply for Coaching</span>
        </button>
      )}
      <button
        className="sidebar-link"
        onClick={toggleTheme}
        title={collapsed && !isMobile ? (theme === "dark" ? "Light Mode" : "Dark Mode") : undefined}
        style={{ marginBottom: 4, justifyContent: collapsed && !isMobile ? "center" : undefined, padding: collapsed && !isMobile ? "9px 0" : undefined }}
      >
        <span style={{ fontSize: 15 }}>{theme === "dark" ? "☀️" : "🌙"}</span>
        {!(collapsed && !isMobile) && <span>{theme === "dark" ? "Light Mode" : "Dark Mode"}</span>}
      </button>
      <button
        className="sidebar-link"
        onClick={() => window.$memberstackDom?.logout().then(() => { window.location.href = "/index.html"; })}
        title={collapsed && !isMobile ? "Sign Out" : undefined}
        style={{ justifyContent: collapsed && !isMobile ? "center" : undefined, padding: collapsed && !isMobile ? "9px 0" : undefined }}
      >
        <Icon.logout />
        {!(collapsed && !isMobile) && <span>Sign Out</span>}
      </button>
      {!(collapsed && !isMobile) && (
        <div id="vast-sync-status" style={{ fontSize: 10, textAlign: "center", marginTop: 6, height: 14, transition: "color 0.3s" }}></div>
      )}
    </div>
  );

  return (
    <>
      {/* Mobile overlay backdrop */}
      {mobileOpen && (
        <div onClick={() => setMobileOpen(false)}
          style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.6)", zIndex: 49 }} />
      )}

      {/* Sidebar panel */}
      <div style={{
        width: w, height: "100vh", background: C.surface,
        borderRight: `1px solid ${C.border}`, display: "flex", flexDirection: "column",
        position: "fixed", left: 0, top: 0, zIndex: 50,
        transform: isMobile ? (mobileOpen ? "translateX(0)" : "translateX(-100%)") : "translateX(0)",
        transition: "width 0.2s ease, transform 0.25s ease",
        overflow: "hidden",
      }}>
        {/* Header */}
        <div style={{ padding: collapsed && !isMobile ? "14px 8px" : "14px 16px", borderBottom: `1px solid ${C.border}`, display: "flex", alignItems: "center", justifyContent: collapsed && !isMobile ? "center" : "space-between", flexShrink: 0 }}>
          {!(collapsed && !isMobile) && (
            <div style={{ minWidth: 0 }}>
              <VASTLogo size="md" />
              <div style={{ marginTop: 6, fontSize: 11, color: C.textMuted, fontWeight: 600, letterSpacing: 0.5, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{company.name}</div>
            </div>
          )}
          {isMobile ? (
            <button onClick={() => setMobileOpen(false)}
              style={{ background: "none", border: "none", color: C.textMuted, fontSize: 22, cursor: "pointer", padding: "4px 8px", lineHeight: 1 }}>✕</button>
          ) : (
            <button
              onClick={() => { const next = !collapsed; setCollapsed(next); localStorage.setItem("vast-sidebar-collapsed", next ? "1" : "0"); }}
              title={collapsed ? "Expand sidebar" : "Collapse sidebar"}
              style={{ background: "none", border: "none", color: C.textMuted, cursor: "pointer", padding: 4, lineHeight: 1, display: "flex", alignItems: "center", borderRadius: 6, flexShrink: 0 }}
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                {collapsed
                  ? <><polyline points="9 18 15 12 9 6" /><line x1="3" y1="12" x2="15" y2="12" /></>
                  : <><polyline points="15 18 9 12 15 6" /><line x1="21" y1="12" x2="9" y2="12" /></>
                }
              </svg>
            </button>
          )}
        </div>

        {/* Scrollable nav */}
        <nav style={{ flex: 1, padding: collapsed && !isMobile ? "12px 4px" : "12px 8px", overflowY: "auto", overflowX: "hidden" }}>{navItems}</nav>

        {/* Footer — always visible */}
        {footer}
      </div>
    </>
  );
}

// ─── MAIN LAYOUT ──────────────────────────────────────────────────────
const MobileMenuContext = React.createContext(() => {});
const SidebarCollapsedContext = React.createContext(false);

function Layout({ children, title, subtitle, action }) {
  const mobile = useMobile();
  const openMobileMenu = React.useContext(MobileMenuContext);
  const sidebarCollapsed = React.useContext(SidebarCollapsedContext);
  const ml = mobile ? 0 : (sidebarCollapsed ? 56 : 220);
  return (
    <div style={{ marginLeft: ml, minHeight: "100vh", background: C.bg, paddingBottom: mobile ? 16 : 0, transition: "margin-left 0.2s ease" }}>
      {/* Header */}
      <div style={{ borderBottom: `1px solid ${C.border}`, padding: mobile ? "14px 16px" : "20px 32px", background: C.surface, display: "flex", alignItems: "center", justifyContent: "space-between", gap: 12, position: "sticky", top: 0, zIndex: 40 }}>
        <div style={{ display: "flex", alignItems: "center", gap: mobile ? 10 : 0, minWidth: 0 }}>
          {mobile && (
            <button onClick={openMobileMenu}
              style={{ background: "none", border: "none", color: C.text, fontSize: 22, cursor: "pointer", padding: "2px 6px", lineHeight: 1, flexShrink: 0 }}>☰</button>
          )}
          <div style={{ minWidth: 0 }}>
            <h1 style={{ fontSize: mobile ? 18 : 26, fontWeight: 800, color: C.text, margin: 0, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{title}</h1>
            {subtitle && <div style={{ fontSize: mobile ? 11 : 13, color: C.textMuted, marginTop: 2, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{subtitle}</div>}
          </div>
        </div>
        {action && <div style={{ flexShrink: 0 }}>{action}</div>}
      </div>
      <div style={{ padding: mobile ? "16px" : "28px 32px" }} className="fade-in">{children}</div>
    </div>
  );
}

// ─── DASHBOARD ────────────────────────────────────────────────────────
function Dashboard({ company, setView }) {
  const q = company.currentQuarter || "This Quarter";
  const tasks = company.quarterlyTasks || [];
  const onTrack = tasks.filter(t => t.status === "on").length;
  const offTrack = tasks.filter(t => t.status === "off").length;
  const done = tasks.filter(t => t.status === "done").length;
  const total = tasks.length;
  const pct = total > 0 ? Math.round(((onTrack + done) / total) * 100) : 0;
  const openIssues = (company.issues || []).filter(i => i.status !== "resolved").length;
  const pendingTodos = (company.todos || []).filter(t => !t.done).length;
  const lastMeeting = company.meetings?.slice(-1)[0];
  const avgRating = company.meetings?.length
    ? (company.meetings.reduce((a, m) => a + (m.rating || 0), 0) / company.meetings.length).toFixed(1)
    : "—";

  // Quarter progress
  const qStart = company.quarterStart ? new Date(company.quarterStart) : null;
  const qEnd = company.quarterEnd ? new Date(company.quarterEnd) : null;
  const today = new Date();
  today.setHours(0,0,0,0);
  const qTotal = qStart && qEnd ? Math.max(1, Math.round((qEnd - qStart) / 86400000)) : 90;
  const qElapsed = qStart ? Math.max(0, Math.round((today - qStart) / 86400000)) : 0;
  const qRemaining = qEnd ? Math.max(0, Math.round((qEnd - today) / 86400000)) : null;
  const qTimePct = Math.min(100, Math.round((qElapsed / qTotal) * 100));

  return (
    <Layout title={`Welcome to ${company.name}`} subtitle={dateStr()}>
      {/* Quarter Progress Banner */}
      <div className="card" style={{ marginBottom: 20, padding: "16px 20px" }}>
        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 10 }}>
          <div>
            <span style={{ fontFamily: "'Barlow Condensed',sans-serif", fontWeight: 800, fontSize: 16, letterSpacing: 1 }}>{q}</span>
            {qStart && qEnd && (
              <span style={{ fontSize: 12, color: C.textMuted, marginLeft: 12 }}>
                {qStart.toLocaleDateString("en-US", { month: "short", day: "numeric" })} — {qEnd.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })}
              </span>
            )}
          </div>
          <div style={{ textAlign: "right" }}>
            {qRemaining !== null && (
              <span style={{ fontSize: 13, fontWeight: 700, color: qRemaining <= 14 ? C.red : qRemaining <= 30 ? C.yellow : C.green }}>
                {qRemaining === 0 ? "Last day!" : `${qRemaining} day${qRemaining !== 1 ? "s" : ""} remaining`}
              </span>
            )}
          </div>
        </div>
        <div style={{ display: "flex", gap: 16, alignItems: "center" }}>
          <div style={{ flex: 1 }}>
            <div style={{ fontSize: 11, color: C.textMuted, marginBottom: 4, display: "flex", justifyContent: "space-between" }}>
              <span>Time elapsed</span><span>{qTimePct}%</span>
            </div>
            <div style={{ height: 6, background: C.border, borderRadius: 3, overflow: "hidden" }}>
              <div style={{ height: "100%", width: `${qTimePct}%`, background: qTimePct > pct + 20 ? C.red : C.yellow, borderRadius: 3, transition: "width 0.4s" }} />
            </div>
          </div>
          <div style={{ flex: 1 }}>
            <div style={{ fontSize: 11, color: C.textMuted, marginBottom: 4, display: "flex", justifyContent: "space-between" }}>
              <span>Tasks complete</span><span>{pct}%</span>
            </div>
            <div style={{ height: 6, background: C.border, borderRadius: 3, overflow: "hidden" }}>
              <div style={{ height: "100%", width: `${pct}%`, background: C.green, borderRadius: 3, transition: "width 0.4s" }} />
            </div>
          </div>
          <button className="btn-ghost" style={{ fontSize: 12, whiteSpace: "nowrap" }} onClick={() => setView("settings")}>Edit Quarter →</button>
        </div>
      </div>

      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill,minmax(140px,1fr))", gap: 16, marginBottom: 24 }}>
        {[
          { label: "Quarterly Tasks", value: `${onTrack + done}/${total}`, sub: "on or completed", color: C.red },
          { label: "Open Issues", value: openIssues, sub: "to resolve", color: C.yellow },
          { label: "Pending To-Dos", value: pendingTodos, sub: "this week", color: C.blue },
          { label: "Avg Meeting Rating", value: avgRating, sub: `of ${company.meetings?.length || 0} meetings`, color: C.green },
        ].map(s => (
          <div key={s.label} className="stat-card">
            <div style={{ fontSize: 36, fontWeight: 800, color: s.color, fontFamily: "'Barlow Condensed',sans-serif" }}>{s.value}</div>
            <div style={{ fontSize: 13, fontWeight: 700, color: C.text, marginTop: 4 }}>{s.label}</div>
            <div style={{ fontSize: 11, color: C.textMuted }}>{s.sub}</div>
          </div>
        ))}
      </div>

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20 }}>
        <div className="card">
          <div className="section-header">
            <h3 style={{ fontSize: 18 }}>{q} — Task Progress</h3>
            <button className="btn-ghost" onClick={() => setView("tasks")}>View All →</button>
          </div>
          <div style={{ marginBottom: 16 }}>
            <div className="progress-bar"><div className="progress-fill" style={{ width: `${pct}%` }} /></div>
            <div style={{ fontSize: 12, color: C.textMuted, marginTop: 6 }}>{pct}% on track or complete</div>
          </div>
          {tasks.slice(0, 5).map(t => (
            <div key={t.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "8px 0", borderBottom: `1px solid ${C.border}` }}>
              <span style={{ fontSize: 14, color: C.text }}>{t.title || "Untitled task"}</span>
              <span className={t.status === "done" ? "tag-done" : t.status === "on" ? "tag-on" : "tag-off"}>
                {t.status === "done" ? "Done" : t.status === "on" ? "On Track" : "Off Track"}
              </span>
            </div>
          ))}
          {!tasks.length && <div style={{ color: C.textMuted, fontSize: 14, textAlign: "center", padding: 20 }}>No tasks yet. Add them in Quarterly Tasks.</div>}
        </div>

        <div style={{ display: "flex", flexDirection: "column", gap: 20 }}>
          <div className="card">
            <div className="section-header">
              <h3 style={{ fontSize: 18 }}>Huddles</h3>
            </div>
            {(company.huddles || [{ id: "huddle-1", name: "Weekly Huddle" }]).map(h => {
              const lastHM = (h.meetings || []).slice(-1)[0];
              return (
                <div key={h.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 0", borderBottom: `1px solid ${C.border}` }}>
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 700 }}>{h.name}</div>
                    {lastHM
                      ? <div style={{ fontSize: 12, color: C.textMuted }}>Last: {dateStr(new Date(lastHM.date))} · <span style={{ color: lastHM.rating >= 8 ? C.green : lastHM.rating >= 6 ? C.yellow : C.red, fontWeight: 700 }}>{lastHM.rating}/10</span></div>
                      : <div style={{ fontSize: 12, color: C.textMuted }}>No meetings yet</div>
                    }
                  </div>
                  <button className="btn-primary" style={{ padding: "6px 14px", fontSize: 12 }} onClick={() => setView("huddle:" + h.id)}>Start →</button>
                </div>
              );
            })}
          </div>

          <div className="card">
            <div className="section-header">
              <h3 style={{ fontSize: 18 }}>Recent Headlines</h3>
              <button className="btn-ghost" onClick={() => setView("headlines")}>View All →</button>
            </div>
            {(company.headlines || []).slice(-3).reverse().map(h => (
              <div key={h.id} style={{ padding: "8px 0", borderBottom: `1px solid ${C.border}`, fontSize: 14 }}>
                <span className="chip" style={{ marginRight: 8, fontSize: 10 }}>{h.type}</span>{h.text}
              </div>
            ))}
            {!(company.headlines || []).length && <div style={{ fontSize: 13, color: C.textMuted }}>No headlines yet.</div>}
          </div>
        </div>
      </div>
    </Layout>
  );
}

// ─── NAVIGATOR ────────────────────────────────────────────────────────
function NavSection({ label, children }) {
  return (
    <div className="card" style={{ marginBottom: 16 }}>
      <div style={{ background: C.red, color: "#fff", fontFamily: "'Barlow Condensed',sans-serif", fontWeight: 800, fontSize: 14, letterSpacing: 2, textTransform: "uppercase", padding: "8px 16px", borderRadius: 6, marginBottom: 16, display: "inline-block" }}>{label}</div>
      {children}
    </div>
  );
}

function Navigator({ company, onSave, navigatorId, navigatorName }) {
  const navigators = company.navigators || [{ id: "nav-1", name: "Navigator", coreValues: ["","",""] }];
  const navObj = navigators.find(n => n.id === navigatorId) || navigators[0] || {};
  const [nav, setNav] = useState(navObj);
  const [saved, setSaved] = useState(false);

  useEffect(() => {
    const n = (company.navigators || []).find(x => x.id === navigatorId) || {};
    setNav(n);
  }, [navigatorId]); // only re-sync when switching navigators, not on every company save

  const set = (k, v) => setNav(n => ({ ...n, [k]: v }));
  const setCV = (i, v) => { const cv = [...(nav.coreValues || ["", "", ""])]; cv[i] = v; set("coreValues", cv); };

  const save = () => {
    const updated = navigators.map(n => n.id === navigatorId ? { ...nav, id: navigatorId, name: navigatorName } : n);
    onSave({ navigators: updated });
    setSaved(true); setTimeout(() => setSaved(false), 2000);
  };

  // Section defined outside component to avoid remount on re-render

  return (
    <Layout title={navigatorName} subtitle="Your company's operating blueprint"
      action={<button className="btn-primary" onClick={save}>{saved ? "✓ Saved" : "Save Navigator"}</button>}>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill,minmax(280px,1fr))", gap: 16 }}>
        <div>
          <NavSection label="Core Values">
            {[0, 1, 2].map(i => (
              <div key={i} className="field">
                <label className="label">Value {i + 1}</label>
                <input placeholder={`Core value ${i + 1}`} value={(nav.coreValues || [])[i] || ""} onChange={e => setCV(i, e.target.value)} />
              </div>
            ))}
          </NavSection>

          <NavSection label="Top Focus">
            <div className="field">
              <label className="label">Purpose — Why we exist</label>
              <input placeholder="Our purpose..." value={nav.purpose || ""} onChange={e => set("purpose", e.target.value)} />
            </div>
            <div className="field">
              <label className="label">Our Avenue — How we deliver</label>
              <input placeholder="Through..." value={nav.avenue || ""} onChange={e => set("avenue", e.target.value)} />
            </div>
          </NavSection>

          <NavSection label="Major Motivator">
            <div className="field">
              <label className="label">What drives us</label>
              <textarea placeholder="Our major motivator is..." value={nav.majorMotivator || ""} onChange={e => set("majorMotivator", e.target.value)} />
            </div>
          </NavSection>
        </div>

        <div>
          <NavSection label="Marketing Strategy">
            <div className="field">
              <label className="label">Target Market</label>
              <input placeholder="We serve..." value={nav.targetMarket || ""} onChange={e => set("targetMarket", e.target.value)} />
            </div>
            <div className="field">
              <label className="label">Why We're Different</label>
              <input placeholder="Unlike others, we..." value={nav.different || ""} onChange={e => set("different", e.target.value)} />
            </div>
            <div className="field">
              <label className="label">Proof</label>
              <input placeholder="We can prove this by..." value={nav.proof || ""} onChange={e => set("proof", e.target.value)} />
            </div>
            <div className="field">
              <label className="label">Our Promise</label>
              <input placeholder="We guarantee..." value={nav.promise || ""} onChange={e => set("promise", e.target.value)} />
            </div>
          </NavSection>

          <NavSection label="2 Year Target">
            <div className="grid2">
              <div className="field">
                <label className="label">Future Date</label>
                <input type="date" value={nav.futureDate || ""} onChange={e => set("futureDate", e.target.value)} />
              </div>
              <div className="field">
                <label className="label">Revenue Goal</label>
                <input placeholder="$0,000,000" value={nav.revenue || ""} onChange={e => set("revenue", e.target.value)} />
              </div>
            </div>
            <div className="field">
              <label className="label">Profit Goal</label>
              <input placeholder="$0,000,000" value={nav.profit || ""} onChange={e => set("profit", e.target.value)} />
            </div>
            <div className="field">
              <label className="label">What Does It Look Like?</label>
              <textarea placeholder="In 2 years, we will..." value={nav.whatLooksLike || ""} onChange={e => set("whatLooksLike", e.target.value)} />
            </div>
          </NavSection>
        </div>
      </div>
    </Layout>
  );
}

// ─── WEEKLY HUDDLE ────────────────────────────────────────────────────
const AGENDA = [
  { id: "intros", label: "Introductions / Good News", minutes: 5 },
  { id: "scoring", label: "Scoring — Review Numbers", minutes: 5 },
  { id: "tasks", label: "Task Review — On/Off Track", minutes: 5 },
  { id: "headlines", label: "Customer & Employee Headlines", minutes: 5 },
  { id: "todos", label: "To-Dos — Confirm Completion", minutes: 5 },
  { id: "problems", label: "Problem Solving (IDS)", minutes: 30 },
  { id: "conclude", label: "Conclude & Rate Meeting", minutes: 5 },
];

function WeeklyHuddle({ company, onSave, huddleId, huddleName }) {
  // Build agenda using per-huddle custom durations if set
  const customMins = ((company.huddles || []).find(h => h.id === huddleId) || {}).agendaMins || {};
  const agenda = AGENDA.map(a => ({ ...a, minutes: customMins[a.id] ?? a.minutes }));

  const [started, setStarted] = useState(false);
  const [activeIdx, setActiveIdx] = useState(0);
  const [elapsed, setElapsed] = useState(0);
  const [segElapsed, setSegElapsed] = useState(0);
  const [notes, setNotes] = useState({});
  const [newHeadline, setNewHeadline] = useState({ type: "Customer", text: "", huddleId: huddleId || "" });
  const defaultDueDate = () => new Date(Date.now() + 7 * 86400000).toISOString().slice(0,10);
  const [newTodo, setNewTodo] = useState({ title: "", assignees: [], dueDate: defaultDueDate() });
  const [newIssue, setNewIssue] = useState({ title: "", priority: "2" });
  const [rating, setRating] = useState(0); // final computed average
  const [memberRatings, setMemberRatings] = useState({}); // { memberId: score }
  const [showRecap, setShowRecap] = useState(false);
  const [done, setDone] = useState(false);
  const [attendance, setAttendance] = useState({});
  const [spotlight, setSpotlight] = useState(null);
  const [spinning, setSpinning] = useState(false);
  const [alreadySelected, setAlreadySelected] = useState([]); // ids selected this session
  // Problem solving session state
  const [focusQueue, setFocusQueue] = useState([]); // up to 3 selected items being discussed
  const [activeIssueId, setActiveIssueId] = useState(null);
  const [issueNotes, setIssueNotes] = useState({});
  const [solvedThisSession, setSolvedThisSession] = useState([]);
  const timerRef = useRef(null);
  const spinRef = useRef(null);
  // Only show members assigned to this huddle (or all if huddle has no member list yet)
  const allMembers = company.members || [];
  const huddleObj = (company.huddles || []).find(h => h.id === huddleId) || {};
  const huddleMemberIds = huddleObj.memberIds;
  const members = huddleMemberIds && huddleMemberIds.length > 0
    ? allMembers.filter(m => huddleMemberIds.includes(m.id))
    : allMembers;

  const addToProblemQueue = (item) => {
    const pq = company.problemQueue || [];
    if (pq.find(p => p.id === item.id)) return; // already in queue
    onSave({ problemQueue: [...pq, item] });
  };
  const seg = agenda[activeIdx];
  const segLimit = seg.minutes * 60;

  useEffect(() => {
    if (started && !done) {
      timerRef.current = setInterval(() => {
        setElapsed(e => e + 1);
        setSegElapsed(e => e + 1);
      }, 1000);
    }
    return () => clearInterval(timerRef.current);
  }, [started, activeIdx, done]);

  const fmt = (s) => `${String(Math.floor(s / 60)).padStart(2, "0")}:${String(s % 60).padStart(2, "0")}`;
  const over = segElapsed > segLimit;

  const next = () => {
    if (activeIdx < agenda.length - 1) { setActiveIdx(i => i + 1); setSegElapsed(0); }
  };
  const prev = () => {
    if (activeIdx > 0) { setActiveIdx(i => i - 1); setSegElapsed(0); }
  };

  const addHeadline = () => {
    if (!newHeadline.text.trim()) return;
    const h = { id: uid(), type: newHeadline.type, text: newHeadline.text, huddleId: newHeadline.huddleId || "", date: now() };
    onSave({ headlines: [...(company.headlines || []), h] });
    setNewHeadline(n => ({ ...n, text: "" }));
  };
  const addTodo = () => {
    if (!newTodo.title.trim()) return;
    const t = { id: uid(), title: newTodo.title, assignees: newTodo.assignees, dueDate: newTodo.dueDate, done: false, createdAt: now() };
    onSave({ todos: [...(company.todos || []), t] });
    setNewTodo({ title: "", assignee: "", dueDate: defaultDueDate() });
  };
  const addIssue = () => {
    if (!newIssue.title.trim()) return;
    const iss = { id: uid(), title: newIssue.title, priority: newIssue.priority, status: "open", createdAt: now() };
    onSave({ issues: [...(company.issues || []), iss] });
    setNewIssue({ title: "", priority: "2" });
  };

  const autoSelect = () => {
    const present = members.filter(m => attendance[m.id] !== false);
    const pool = present.filter(m => !alreadySelected.includes(m.id));
    if (!pool.length) return;
    setSpotlight(null);
    setSpinning(true);
    let count = 0;
    const total = 18;
    const cycle = () => {
      const idx = Math.floor(Math.random() * pool.length);
      setSpotlight(pool[idx]);
      count++;
      if (count < total) {
        spinRef.current = setTimeout(cycle, 80 + count * 12);
      } else {
        setSpinning(false);
        setAlreadySelected(s => [...s, pool[idx].id]);
      }
    };
    cycle();
  };

  const buildRecap = (mtgData, avgRating) => {
    const d = new Date(mtgData.date);
    const dateLabel = d.toLocaleDateString("en-US", { weekday: "long", month: "long", day: "numeric", year: "numeric" });
    const lines = [];
    lines.push(`VAST WEEKLY HUDDLE RECAP`);
    lines.push(`${huddleName} — ${dateLabel}`);
    lines.push(`Duration: ${Math.round(elapsed / 60)} min  |  Meeting Rating: ${avgRating}/10`);
    lines.push("");

    // Attendance
    const present = (company.members || []).filter(m => attendance[m.id] !== false);
    if (present.length) {
      lines.push("ATTENDEES");
      lines.push(present.map(m => m.name).join(", "));
      lines.push("");
    }

    // Headlines
    const activeHeadlines = (company.headlines || []).filter(h => !h.reviewed);
    if (activeHeadlines.length) {
      lines.push("HEADLINES FROM THE WEEK");
      activeHeadlines.forEach(h => lines.push(`  [${h.type.toUpperCase()}] ${h.text}`));
      lines.push("");
    }

    // Quarterly tasks — off track
    const offTrack = (company.quarterlyTasks || []).filter(t => t.status === "off");
    if (offTrack.length) {
      lines.push("OFF-TRACK QUARTERLY TASKS");
      offTrack.forEach(t => lines.push(`  ✗ ${t.title}${t.who ? ` (${t.who})` : ""}`));
      lines.push("");
    }

    // All open to-dos grouped by assignee
    const today = new Date(); today.setHours(0,0,0,0);
    const todayStr = new Date().toISOString().slice(0,10);
    const allOpen = (company.todos || []).filter(t => !t.done);
    if (allOpen.length) {
      lines.push("OPEN TO-DOS BY TEAM MEMBER");
      // Group by assignee
      const grouped = {};
      allOpen.forEach(t => {
        const assignees = getAssignees(t);
        if (assignees.length === 0) {
          if (!grouped["Unassigned"]) grouped["Unassigned"] = [];
          grouped["Unassigned"].push(t);
        } else {
          assignees.forEach(name => {
            if (!grouped[name]) grouped[name] = [];
            grouped[name].push(t);
          });
        }
      });
      Object.entries(grouped).sort(([a],[b]) => a === "Unassigned" ? 1 : b === "Unassigned" ? -1 : a.localeCompare(b)).forEach(([name, items]) => {
        lines.push(`  ${name}:`);
        items.forEach(t => {
          const isOverdue = t.dueDate && new Date(t.dueDate) < today;
          const isNew = t.createdAt && t.createdAt.slice(0,10) === todayStr;
          const tag = isOverdue ? " ⚠ OVERDUE" : isNew ? " ★ NEW" : "";
          lines.push(`    □ ${t.title}${t.dueDate ? ` (Due ${dateStr(new Date(t.dueDate))})` : ""}${tag}`);
        });
      });
      lines.push("");
    }

    // Problems solved
    if (solvedThisSession.length) {
      lines.push("PROBLEMS SOLVED");
      solvedThisSession.forEach(s => lines.push(`  ✓ ${s.title}${s.notes ? `: ${s.notes}` : ""}`));
      lines.push("");
    }

    // Notes
    if (notes.conclude) {
      lines.push("MEETING NOTES");
      lines.push(`  ${notes.conclude}`);
      lines.push("");
    }

    // Individual ratings
    const ratingEntries = Object.entries(memberRatings);
    if (ratingEntries.length > 1) {
      lines.push("INDIVIDUAL RATINGS");
      ratingEntries.forEach(([mid, score]) => {
        const m = (company.members || []).find(x => x.id === mid);
        lines.push(`  ${m ? m.name : "Member"}: ${score}/10`);
      });
      lines.push(`  Average: ${avgRating}/10`);
      lines.push("");
    }

    lines.push("—".repeat(40));
    lines.push("Generated by VAST Platform");
    return lines.join("\n");
  };

  const finishMeeting = () => {
    const scores = Object.values(memberRatings).filter(Boolean);
    const avgRating = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : rating;
    if (!avgRating) return;
    const mtg = {
      id: uid(), date: now(), rating: avgRating, memberRatings, totalMinutes: Math.round(elapsed / 60),
      notes, headlines: (company.headlines || []).filter(h => !h.reviewed).slice(-5),
      reviewedHeadlines: (company.headlines || []).filter(h => h.reviewed).slice(-20),
      completedTodos: (company.todos || []).filter(t => t.done).slice(-20),
      todos: (company.todos || []).filter(t => !t.done).slice(-5),
      solvedProblems: solvedThisSession
    };
    // Archive quarter snapshot (once per quarter, keyed by currentQuarter)
    const qh = company.quarterHistory || [];
    const qLabel = company.currentQuarter || "Unknown Quarter";
    const existingIdx = qh.findIndex(q => q.quarter === qLabel);
    const snapshot = {
      quarter: qLabel,
      archivedAt: now(),
      tasks: (company.quarterlyTasks || []).map(t => ({ title: t.title, who: t.who, status: t.status })),
      todos: (company.todos || []).map(t => ({ title: t.title, assignee: t.assignee, done: t.done })),
      solvedProblems: [
        ...(existingIdx >= 0 ? (qh[existingIdx].solvedProblems || []) : []),
        ...solvedThisSession
      ],
      meetingRatings: [
        ...(existingIdx >= 0 ? (qh[existingIdx].meetingRatings || []) : []),
        { date: now(), rating }
      ]
    };
    const newQH = existingIdx >= 0
      ? qh.map((q, i) => i === existingIdx ? snapshot : q)
      : [...qh, snapshot];
    const allHuddles = company.huddles || [{ id: "huddle-1", name: "Weekly Huddle" }];
    const updatedHuddles = allHuddles.map(h => h.id === huddleId
      ? { ...h, meetings: [...(h.meetings || []), mtg] }
      : h
    );
    onSave({ huddles: updatedHuddles, meetings: [...(company.meetings || []), mtg], quarterHistory: newQH });
    setRating(avgRating);
    setShowRecap(true);
    setDone(true);
    clearInterval(timerRef.current);
    clearTimeout(spinRef.current);
  };

  if (done) {
    const recap = buildRecap({ date: now() }, rating);
    const resetMeeting = () => { setStarted(false); setActiveIdx(0); setElapsed(0); setSegElapsed(0); setRating(0); setMemberRatings({}); setDone(false); setShowRecap(false); setNotes({}); setAttendance({}); setSpotlight(null); setAlreadySelected([]); setFocusQueue([]); setActiveIssueId(null); setIssueNotes({}); setSolvedThisSession([]); clearTimeout(spinRef.current); };
    return (
      <Layout title="Meeting Complete!" subtitle="Great work — keep the momentum going">
        <div style={{ maxWidth: 680, margin: "0 auto" }} className="fade-in">
          <div style={{ textAlign: "center", marginBottom: 24 }}>
            <div style={{ fontSize: 64, marginBottom: 8 }}>🎉</div>
            <div style={{ fontSize: 52, fontWeight: 800, color: rating >= 8 ? C.green : rating >= 6 ? C.yellow : C.red, fontFamily: "'Barlow Condensed',sans-serif", lineHeight: 1 }}>{rating}/10</div>
            <div style={{ color: C.textMuted, marginTop: 4, fontSize: 14 }}>Average Meeting Rating · {fmt(elapsed)}</div>
          </div>

          {Object.keys(memberRatings).length > 1 && (
            <div className="card" style={{ marginBottom: 20 }}>
              <h3 style={{ fontSize: 16, marginBottom: 12 }}>Individual Ratings</h3>
              <div style={{ display: "flex", flexWrap: "wrap", gap: 10 }}>
                {Object.entries(memberRatings).map(([mid, score]) => {
                  const m = (company.members || []).find(x => x.id === mid);
                  return (
                    <div key={mid} style={{ display: "flex", flexDirection: "column", alignItems: "center", background: C.surface2, borderRadius: 8, padding: "10px 16px", minWidth: 80 }}>
                      <div style={{ fontSize: 24, fontWeight: 800, color: score >= 8 ? C.green : score >= 6 ? C.yellow : C.red, fontFamily: "'Barlow Condensed',sans-serif" }}>{score}</div>
                      <div style={{ fontSize: 11, color: C.textMuted, marginTop: 2 }}>{m ? m.name : "—"}</div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          <div className="card" style={{ marginBottom: 20 }}>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 }}>
              <h3 style={{ fontSize: 16 }}>Meeting Recap</h3>
              <button className="btn-primary" style={{ padding: "8px 16px", fontSize: 12 }}
                onClick={() => { navigator.clipboard.writeText(recap).catch(() => {}); }}>
                📋 Copy Recap
              </button>
            </div>
            <pre style={{ fontSize: 12, lineHeight: 1.7, color: C.textMuted, whiteSpace: "pre-wrap", fontFamily: "'Barlow',sans-serif", background: C.surface2, borderRadius: 6, padding: "16px", maxHeight: 400, overflowY: "auto" }}>{recap}</pre>
          </div>

          <button className="btn-primary" style={{ width: "100%", padding: "14px", fontSize: 15 }} onClick={resetMeeting}>
            End & Return to Dashboard
          </button>
        </div>
      </Layout>
    );
  }

  if (!started) {
    return (
      <Layout title={huddleName} subtitle={`${agenda.reduce((s,a)=>s+a.minutes,0)} min · Adjust times before starting`}>
        <div style={{ maxWidth: 600, margin: "0 auto" }}>
          <div className="card" style={{ marginBottom: 20 }}>
            <h3 style={{ fontSize: 20, marginBottom: 16 }}>Meeting Agenda</h3>
            <div style={{ fontSize: 12, color: C.textMuted, marginBottom: 12, fontStyle: "italic" }}>Click any time to adjust — saved as your default for this huddle.</div>
            {agenda.map((a, i) => (
              <div key={a.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 0", borderBottom: `1px solid ${C.border}` }}>
                <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                  <div style={{ width: 28, height: 28, background: C.surface2, borderRadius: 6, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 12, fontWeight: 700, color: C.red }}>{i + 1}</div>
                  <span style={{ fontSize: 15 }}>{a.label}</span>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <input
                    type="number"
                    min="1"
                    max="180"
                    value={a.minutes}
                    onChange={e => {
                      const val = Math.max(1, parseInt(e.target.value) || 1);
                      const allHuddles = company.huddles || [];
                      const updated = allHuddles.map(h => h.id === huddleId
                        ? { ...h, agendaMins: { ...(h.agendaMins || {}), [a.id]: val } }
                        : h
                      );
                      onSave({ huddles: updated });
                    }}
                    style={{ width: 52, textAlign: "center", padding: "5px 6px", fontSize: 13, fontWeight: 700, border: `1px solid ${C.border}`, borderRadius: 6, background: C.surface2, color: C.text, fontFamily: "'Barlow',sans-serif" }}
                  />
                  <span style={{ fontSize: 13, color: C.textMuted }}>min</span>
                </div>
              </div>
            ))}
            <div style={{ display: "flex", justifyContent: "space-between", padding: "12px 0", color: C.textMuted, fontSize: 14 }}>
              <span>Total</span><span style={{ fontWeight: 700, color: C.text }}>{agenda.reduce((s, a) => s + a.minutes, 0)} min</span>
            </div>
          </div>
          <button className="btn-primary" style={{ width: "100%", padding: "16px", fontSize: 16 }} onClick={() => setStarted(true)}>
            ▶  Start Huddle
          </button>
        </div>
      </Layout>
    );
  }

  return (
    <Layout title={`${huddleName} — Live`} subtitle={`Total: ${fmt(elapsed)}`}>
      <div style={{ display: "grid", gridTemplateColumns: "min(280px,100%) 1fr", gap: 20 }} className="mob-stack">
        {/* Agenda sidebar */}
        <div>
          <div className="card" style={{ marginBottom: 12 }}>
            <div style={{ textAlign: "center" }}>
              <div className="timer-display" style={{ color: over ? C.red : C.text }}>{fmt(segElapsed)}</div>
              <div style={{ fontSize: 12, color: C.textMuted, marginTop: 4 }}>/ {seg.minutes}:00 allocated</div>
              {over && <div style={{ color: C.red, fontSize: 11, fontWeight: 700, marginTop: 4 }}>OVERTIME</div>}
            </div>
          </div>
          {agenda.map((a, i) => (
            <div key={a.id} className={`huddle-item ${i === activeIdx ? "active" : ""} ${i < activeIdx ? "done" : ""}`}
              onClick={() => { setActiveIdx(i); setSegElapsed(0); }}>
              <div style={{ width: 22, height: 22, background: i < activeIdx ? C.green : i === activeIdx ? C.red : C.surface2, borderRadius: "50%", display: "flex", alignItems: "center", justifyContent: "center", flexShrink: 0 }}>
                {i < activeIdx ? <Icon.check /> : <span style={{ fontSize: 10, fontWeight: 700 }}>{i + 1}</span>}
              </div>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 13, fontWeight: 600 }}>{a.label}</div>
                <div style={{ fontSize: 11, color: C.textMuted }}>{a.minutes} min</div>
              </div>
            </div>
          ))}
          <div style={{ display: "flex", gap: 8, marginTop: 12 }}>
            <button className="btn-secondary" style={{ flex: 1 }} onClick={prev} disabled={activeIdx === 0}>← Back</button>
            <button className="btn-primary" style={{ flex: 1 }} onClick={next} disabled={activeIdx === AGENDA.length - 1}>Next →</button>
          </div>
        </div>

        {/* Content area */}
        <div className="fade-in" key={activeIdx}>
          <div className="card" style={{ marginBottom: 16 }}>
            <h2 style={{ fontSize: 24, marginBottom: 4 }}>{seg.label}</h2>
            <div style={{ fontSize: 13, color: C.textMuted }}>{seg.minutes} minutes allocated</div>
          </div>

          {/* SCORING segment */}
          {activeIdx === 1 && (() => {
            const measurables = company.scorecard?.measurables || [];
            const entries = company.scorecard?.entries || {};
            // Build week list for this quarter
            const qStart = company.quarterStart ? new Date(company.quarterStart) : new Date(Date.now() - 12 * 7 * 86400000);
            const qEnd = company.quarterEnd ? new Date(company.quarterEnd) : new Date();
            const weeks = weeksInRange(qStart, qEnd);
            const curWk = weekKey();

            const setEntry = (measId, wk, val) => {
              const updated = { ...entries, [wk]: { ...(entries[wk] || {}), [measId]: val } };
              onSave({ scorecard: { ...company.scorecard, entries: updated } });
            };

            const meetsGoal = (val, m) => {
              if (val === "" || val === undefined || val === null) return null;
              const v = parseFloat(val), t = parseFloat(m.target);
              if (isNaN(v) || isNaN(t)) return null;
              const op = m.operator || "gte";
              if (op === "gte") return v >= t;
              if (op === "lte") return v <= t;
              if (op === "gt")  return v > t;
              if (op === "lt")  return v < t;
              if (op === "eq")  return v === t;
              return null;
            };

            if (measurables.length === 0) return (
              <div className="card">
                <div style={{ color: C.textMuted, fontSize: 14 }}>No measurables set up yet. Add them in the Scorecard section.</div>
              </div>
            );

            return (
              <div className="card" style={{ padding: 0, overflow: "hidden" }}>
                <div style={{ padding: "16px 20px 12px", borderBottom: `1px solid ${C.border}` }}>
                  <h3 style={{ fontSize: 18, margin: 0 }}>Scorecard — {company.currentQuarter || "This Quarter"}</h3>
                  <div style={{ fontSize: 12, color: C.textMuted, marginTop: 4 }}>{weeks.length} weeks · enter this week's numbers in the <span style={{ color: C.red, fontWeight: 700 }}>highlighted column</span></div>
                </div>
                <div style={{ overflowX: "auto", WebkitOverflowScrolling: "touch" }}>
                  <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 13 }}>
                    <thead>
                      <tr>
                        <th style={{ textAlign: "left", padding: "10px 16px", fontWeight: 700, fontSize: 11, letterSpacing: 1, textTransform: "uppercase", color: C.textMuted, background: C.surface2, position: "sticky", left: 0, zIndex: 2, minWidth: 140, borderBottom: `1px solid ${C.border}` }}>Measurable</th>
                        <th style={{ textAlign: "center", padding: "10px 8px", fontWeight: 700, fontSize: 11, letterSpacing: 1, textTransform: "uppercase", color: C.textMuted, background: C.surface2, minWidth: 60, borderBottom: `1px solid ${C.border}` }}>Goal</th>
                        {weeks.map(wk => (
                          <th key={wk} style={{ textAlign: "center", padding: "8px 6px", fontWeight: wk === curWk ? 800 : 600, fontSize: 11, color: wk === curWk ? C.red : C.textMuted, background: wk === curWk ? `rgba(230,51,41,0.07)` : C.surface2, minWidth: 72, borderBottom: `1px solid ${C.border}`, borderLeft: `1px solid ${wk === curWk ? "rgba(230,51,41,0.3)" : C.border}`, whiteSpace: "nowrap" }}>
                            {weekLabel(wk)}
                            {wk === curWk && <div style={{ fontSize: 9, letterSpacing: 0.5 }}>THIS WEEK</div>}
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {measurables.map((m, mi) => (
                        <tr key={m.id} style={{ background: mi % 2 === 0 ? "transparent" : `${C.surface2}55` }}>
                          <td style={{ padding: "10px 16px", fontWeight: 600, fontSize: 13, position: "sticky", left: 0, background: mi % 2 === 0 ? C.surface : C.surface2, zIndex: 1, borderBottom: `1px solid ${C.border}` }}>
                            <div>{m.name}</div>
                            {m.owner && <div style={{ fontSize: 10, color: C.textMuted, marginTop: 2 }}>{m.owner}</div>}
                          </td>
                          <td style={{ textAlign: "center", padding: "10px 8px", color: C.textMuted, fontSize: 12, borderBottom: `1px solid ${C.border}`, whiteSpace: "nowrap" }}>{({gte:"≥",lte:"≤",gt:">",lt:"<",eq:"="})[m.operator||"gte"]} {m.target}{m.unit ? ` ${m.unit}` : ""}</td>
                          {weeks.map(wk => {
                            const val = entries[wk]?.[m.id] ?? "";
                            const met = meetsGoal(val, m);
                            const isCur = wk === curWk;
                            return (
                              <td key={wk} style={{ textAlign: "center", padding: "6px 4px", borderBottom: `1px solid ${C.border}`, borderLeft: `1px solid ${isCur ? "rgba(230,51,41,0.3)" : C.border}`, background: isCur ? `rgba(230,51,41,0.05)` : "transparent" }}>
                                {isCur ? (
                                  <input
                                    type="text"
                                    value={val}
                                    onChange={e => setEntry(m.id, wk, e.target.value)}
                                    placeholder="—"
                                    style={{ width: 60, textAlign: "center", padding: "5px 4px", fontSize: 13, fontWeight: 700, background: met === true ? "rgba(34,197,94,0.15)" : met === false ? "rgba(230,51,41,0.15)" : C.surface2, border: `1px solid ${met === true ? C.green : met === false ? C.red : C.border}`, borderRadius: 5, color: met === true ? C.green : met === false ? C.red : C.text, outline: "none" }}
                                  />
                                ) : (
                                  <span style={{ fontSize: 13, fontWeight: val !== "" ? 700 : 400, color: met === true ? C.green : met === false ? C.red : C.textDim }}>
                                    {val !== "" ? val : "—"}
                                  </span>
                                )}
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            );
          })()}

          {/* TASK REVIEW */}
          {activeIdx === 2 && (
            <div className="card">
              <h3 style={{ fontSize: 18, marginBottom: 4 }}>Quarterly Task Review</h3>
              <div style={{ fontSize: 13, color: C.textMuted, marginBottom: 16 }}>Update each task's status for this week.</div>
              {(company.quarterlyTasks || []).map(t => (
                <div key={t.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "12px 0", borderBottom: `1px solid ${C.border}`, gap: 12 }}>
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <div style={{ fontSize: 14, fontWeight: 600, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{t.title}</div>
                    {t.who && <div style={{ fontSize: 12, color: C.textMuted }}>{t.who}</div>}
                  </div>
                  <div style={{ display: "flex", alignItems: "center", gap: 6, flexShrink: 0 }}>
                    {["on","off","done"].map(s => {
                      const isActive = t.status === s;
                      const bg = isActive ? (s === "off" ? "rgba(230,51,41,0.2)" : "rgba(34,197,94,0.2)") : C.surface2;
                      const col = isActive ? (s === "off" ? C.red : C.green) : C.textMuted;
                      const bor = isActive ? (s === "off" ? C.red : C.green) : C.border;
                      return (
                        <button key={s} onClick={() => onSave({ quarterlyTasks: (company.quarterlyTasks||[]).map(x => x.id === t.id ? { ...x, status: s } : x) })}
                          style={{ padding: "5px 12px", borderRadius: 5, fontSize: 11, fontWeight: 700, fontFamily: "'Barlow',sans-serif", cursor: "pointer", border: `1px solid ${bor}`, background: bg, color: col }}>
                          {s === "on" ? "On Track" : s === "off" ? "Off Track" : "Done"}
                        </button>
                      );
                    })}
                    {t.status === "off" && (
                      <button onClick={() => addToProblemQueue({ id: t.id, title: t.title, source: "task", sourceLabel: "Task" })}
                        style={{ padding: "5px 10px", borderRadius: 5, border: `1px solid rgba(230,51,41,0.4)`, background: (company.problemQueue||[]).find(p=>p.id===t.id) ? "rgba(230,51,41,0.2)" : C.surface2, color: (company.problemQueue||[]).find(p=>p.id===t.id) ? C.red : C.textMuted, fontFamily:"'Barlow',sans-serif", fontWeight:700, fontSize:11, cursor:"pointer", whiteSpace:"nowrap" }}>
                        {(company.problemQueue||[]).find(p=>p.id===t.id) ? "✓ Queued" : "⚑ Problem Solve"}
                      </button>
                    )}
                  </div>
                </div>
              ))}
              {!company.quarterlyTasks?.length && <div style={{ color: C.textMuted, padding: "16px 0" }}>No tasks yet. Add them in Quarterly Tasks.</div>}
            </div>
          )}

          {/* HEADLINES */}
          {activeIdx === 3 && (() => {
            const unreviewed = (company.headlines || []).filter(h => !h.reviewed);
            const markReviewed = (id) => onSave({ headlines: company.headlines.map(h => h.id === id ? { ...h, reviewed: true, reviewedAt: now() } : h) });
            return (
              <div className="card">
                <h3 style={{ fontSize: 18, marginBottom: 4 }}>Headlines</h3>
                <div style={{ fontSize: 13, color: C.textMuted, marginBottom: 16 }}>Mark reviewed to remove from active list. Reviewed headlines stay in meeting history.</div>
                {unreviewed.length === 0 && (
                  <div style={{ color: C.textMuted, fontSize: 13, padding: "12px 0", marginBottom: 12 }}>All headlines reviewed. Add new ones below.</div>
                )}
                {unreviewed.map(h => (
                  <div key={h.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 0", borderBottom: `1px solid ${C.border}`, gap: 8 }}>
                    <div style={{ fontSize: 14, flex: 1 }}>
                      <span className="chip" style={{ marginRight: 8, fontSize: 10, background: h.type === "Customer" ? "rgba(59,130,246,0.15)" : "rgba(34,197,94,0.1)", borderColor: h.type === "Customer" ? "rgba(59,130,246,0.3)" : "rgba(34,197,94,0.2)", color: h.type === "Customer" ? C.blue : C.green }}>{h.type}</span>
                      {h.text}
                    </div>
                    <div style={{ display: "flex", gap: 6, flexShrink: 0 }}>
                      <button onClick={() => markReviewed(h.id)}
                        style={{ padding: "4px 10px", borderRadius: 5, border: `1px solid rgba(34,197,94,0.4)`, background: "rgba(34,197,94,0.1)", color: C.green, fontFamily:"'Barlow',sans-serif", fontWeight:700, fontSize:11, cursor:"pointer", whiteSpace:"nowrap" }}>
                        ✓ Reviewed
                      </button>
                      <button onClick={() => addToProblemQueue({ id: h.id, title: h.text, source: "headline", sourceLabel: h.type + " Headline" })}
                        style={{ padding: "4px 10px", borderRadius: 5, border: `1px solid rgba(230,51,41,0.4)`, background: (company.problemQueue||[]).find(p=>p.id===h.id) ? "rgba(230,51,41,0.2)" : C.surface2, color: (company.problemQueue||[]).find(p=>p.id===h.id) ? C.red : C.textMuted, fontFamily:"'Barlow',sans-serif", fontWeight:700, fontSize:11, cursor:"pointer", whiteSpace:"nowrap" }}>
                        {(company.problemQueue||[]).find(p=>p.id===h.id) ? "✓ Queued" : "⚑ Problem Solve"}
                      </button>
                    </div>
                  </div>
                ))}
                <div style={{ marginTop: 16 }}>
                  <h4 style={{ fontSize: 14, fontWeight: 700, marginBottom: 10, color: C.textMuted, letterSpacing: 1, textTransform: "uppercase", fontSize: 11 }}>Add New Headline</h4>
                  <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                    <select value={newHeadline.type} onChange={e => setNewHeadline(n => ({ ...n, type: e.target.value }))} style={{ width: 130, flexShrink: 0 }}>
                      <option>Customer</option><option>Employee</option>
                    </select>
                    <select value={newHeadline.huddleId || ""} onChange={e => setNewHeadline(n => ({ ...n, huddleId: e.target.value }))} style={{ width: 150, flexShrink: 0 }}>
                      <option value="">No Huddle</option>
                      {(company.huddles || []).map(h => <option key={h.id} value={h.id}>{h.name}</option>)}
                    </select>
                    <input placeholder="Headline..." value={newHeadline.text} onChange={e => setNewHeadline(n => ({ ...n, text: e.target.value }))} onKeyDown={e => e.key === "Enter" && addHeadline()} style={{ flex: 1, minWidth: 160 }} />
                    <button className="btn-primary" style={{ padding: "10px 16px" }} onClick={addHeadline}>Add</button>
                  </div>
                </div>
              </div>
            );
          })()}

          {/* TO-DOS */}
          {activeIdx === 4 && (() => {
            const pending = (company.todos || []).filter(t => !t.done);
            const completeTodo = (id) => onSave({ todos: company.todos.map(x => x.id === id ? { ...x, done: true, completedAt: now() } : x) });
            return (
              <div className="card">
                <h3 style={{ fontSize: 18, marginBottom: 4 }}>To-Do Review</h3>
                <div style={{ fontSize: 13, color: C.textMuted, marginBottom: 16 }}>Mark complete to remove from active list. Completed to-dos are saved to history.</div>
                {pending.length === 0 && (
                  <div style={{ color: C.textMuted, fontSize: 13, padding: "12px 0", marginBottom: 12 }}>All to-dos complete! Add new ones below.</div>
                )}
                {pending.map(t => {
                  const isOverdue = t.dueDate && new Date(t.dueDate) < new Date();
                  return (
                    <div key={t.id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "10px 0", borderBottom: `1px solid ${C.border}` }}>
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ fontSize: 14, fontWeight: 500 }}>{t.title}</div>
                        <div style={{ fontSize: 11, color: isOverdue ? C.red : C.textMuted, marginTop: 2 }}>
                          {getAssignees(t).length > 0 && <span>{getAssignees(t).join(", ")}</span>}
                          {getAssignees(t).length > 0 && t.dueDate && <span> · </span>}
                          {t.dueDate && <span style={{ fontWeight: isOverdue ? 700 : 400 }}>{isOverdue ? "⚠ Overdue — " : "Due "}{dateStr(new Date(t.dueDate))}</span>}
                        </div>
                      </div>
                      <div style={{ display: "flex", gap: 6, flexShrink: 0 }}>
                        <button onClick={() => completeTodo(t.id)}
                          style={{ padding: "5px 12px", borderRadius: 5, border: `1px solid rgba(34,197,94,0.4)`, background: "rgba(34,197,94,0.1)", color: C.green, fontFamily:"'Barlow',sans-serif", fontWeight:700, fontSize:11, cursor:"pointer", whiteSpace:"nowrap" }}>
                          ✓ Complete
                        </button>
                        <button onClick={() => addToProblemQueue({ id: t.id, title: t.title, source: "todo", sourceLabel: "To-Do" })}
                          style={{ padding: "5px 10px", borderRadius: 5, border: `1px solid rgba(230,51,41,0.4)`, background: (company.problemQueue||[]).find(p=>p.id===t.id) ? "rgba(230,51,41,0.2)" : C.surface2, color: (company.problemQueue||[]).find(p=>p.id===t.id) ? C.red : C.textMuted, fontFamily:"'Barlow',sans-serif", fontWeight:700, fontSize:11, cursor:"pointer", whiteSpace:"nowrap" }}>
                          {(company.problemQueue||[]).find(p=>p.id===t.id) ? "✓ Queued" : "⚑ Problem Solve"}
                        </button>
                      </div>
                    </div>
                  );
                })}
                <div style={{ marginTop: 16 }}>
                  <h4 style={{ fontSize: 11, fontWeight: 700, letterSpacing: 1, textTransform: "uppercase", color: C.textMuted, marginBottom: 10 }}>Add New To-Do</h4>
                  <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginBottom: members.length ? 8 : 0 }}>
                    <input placeholder="Task..." value={newTodo.title} onChange={e => setNewTodo(n => ({ ...n, title: e.target.value }))} style={{ flex: 2, minWidth: 160 }} />
                    <input type="date" value={newTodo.dueDate} onChange={e => setNewTodo(n => ({ ...n, dueDate: e.target.value }))} style={{ flex: 1, minWidth: 130 }} />
                    <button className="btn-primary" style={{ padding: "10px 16px" }} onClick={addTodo}>Add</button>
                  </div>
                  {members.length > 0 && (
                    <div style={{ display: "flex", flexWrap: "wrap", gap: 6, alignItems: "center" }}>
                      <span style={{ fontSize: 11, color: C.textMuted, marginRight: 2 }}>Assign to:</span>
                      {members.map(m => {
                        const sel = (newTodo.assignees || []).includes(m.name);
                        return (
                          <button key={m.id} onClick={() => setNewTodo(n => ({ ...n, assignees: sel ? n.assignees.filter(a => a !== m.name) : [...(n.assignees||[]), m.name] }))}
                            style={{ padding: "3px 10px", borderRadius: 20, fontSize: 12, fontWeight: 600, cursor: "pointer", fontFamily: "'Barlow',sans-serif", transition: "all 0.15s",
                              background: sel ? "rgba(230,51,41,0.15)" : C.surface2,
                              color: sel ? C.red : C.textMuted,
                              border: `1px solid ${sel ? "rgba(230,51,41,0.4)" : C.border}` }}>
                            {sel ? "✓ " : ""}{m.name}
                          </button>
                        );
                      })}
                      <button onClick={() => {
                        const allNames = members.map(m => m.name);
                        const allSel = allNames.every(n => (newTodo.assignees||[]).includes(n));
                        setNewTodo(n => ({ ...n, assignees: allSel ? [] : allNames }));
                      }} style={{ padding: "3px 10px", borderRadius: 20, fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: "'Barlow',sans-serif", background: C.surface2, color: C.textMuted, border: `1px solid ${C.border}` }}>
                        {members.every(m => (newTodo.assignees||[]).includes(m.name)) ? "✓ Everyone" : "Everyone"}
                      </button>
                    </div>
                  )}
                </div>
              </div>
            );
          })()}

          {/* PROBLEM SOLVING */}
          {activeIdx === 5 && (() => {
            const pq = company.problemQueue || [];
            const openIssues = (company.issues || []).filter(i => i.status !== "resolved");
            // All items available for problem solving (queue + open issues not already in queue)
            const allItems = [
              ...pq,
              ...openIssues.filter(i => !pq.find(p => p.id === i.id)).map(i => ({ id: i.id, title: i.title, source: "issue", sourceLabel: `P${i.priority} Issue` }))
            ].filter(item => !solvedThisSession.find(s => s.id === item.id));

            const inFocus = focusQueue;
            const pending = allItems.filter(item => !inFocus.find(f => f.id === item.id));
            const canAddMore = inFocus.length < 3;
            const activeItem = inFocus.find(f => f.id === activeIssueId);

            const selectForFocus = (item) => {
              if (inFocus.length >= 3) return;
              setFocusQueue(q => [...q, item]);
              if (!activeIssueId) setActiveIssueId(item.id);
            };
            const markSolved = (item) => {
              setSolvedThisSession(s => [...s, { ...item, notes: issueNotes[item.id] || "", solvedAt: now() }]);
              setFocusQueue(q => q.filter(f => f.id !== item.id));
              // remove from problemQueue in company data
              onSave({ problemQueue: pq.filter(p => p.id !== item.id) });
              const next = inFocus.find(f => f.id !== item.id);
              setActiveIssueId(next ? next.id : null);
            };
            const markNotSolved = (item) => {
              setFocusQueue(q => q.filter(f => f.id !== item.id));
              const next = inFocus.find(f => f.id !== item.id);
              setActiveIssueId(next ? next.id : null);
            };

            return (
              <div className="fade-in">
                {/* Add new issue */}
                <div className="card" style={{ marginBottom: 16 }}>
                  <h3 style={{ fontSize: 18, marginBottom: 12 }}>Problem Solving — IDS</h3>
                  <div style={{ display: "flex", gap: 8 }}>
                    <input placeholder="Identify a new issue..." value={newIssue.title} onChange={e => setNewIssue(n => ({ ...n, title: e.target.value }))} style={{ flex: 1 }} onKeyDown={e => e.key === "Enter" && addIssue()} />
                    <select value={newIssue.priority} onChange={e => setNewIssue(n => ({ ...n, priority: e.target.value }))} style={{ width: 110 }}>
                      <option value="1">Priority 1</option>
                      <option value="2">Priority 2</option>
                      <option value="3">Priority 3</option>
                    </select>
                    <button className="btn-primary" style={{ padding: "10px 16px" }} onClick={addIssue}>Add</button>
                  </div>
                </div>

                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
                  {/* LEFT: Problem queue + selection */}
                  <div>
                    {/* Focus queue */}
                    <div className="card" style={{ marginBottom: 12 }}>
                      <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 }}>
                        <h4 style={{ fontSize: 15 }}>Focus Queue <span style={{ color: C.textMuted, fontSize: 12 }}>({inFocus.length}/3)</span></h4>
                        {!canAddMore && <span style={{ fontSize: 11, color: C.yellow, fontWeight: 700 }}>MAX 3 SELECTED</span>}
                      </div>
                      {inFocus.length === 0 && (
                        <div style={{ fontSize: 13, color: C.textMuted, textAlign: "center", padding: "12px 0" }}>Select up to 3 problems below to discuss.</div>
                      )}
                      {inFocus.map((item, idx) => (
                        <div key={item.id} onClick={() => setActiveIssueId(item.id)}
                          style={{ padding: "10px 12px", borderRadius: 7, border: `1px solid ${activeIssueId === item.id ? C.red : C.border}`, background: activeIssueId === item.id ? C.redGlow : C.surface2, marginBottom: 6, cursor: "pointer", transition: "all 0.15s" }}>
                          <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                            <div style={{ width: 20, height: 20, borderRadius: "50%", background: activeIssueId === item.id ? C.red : C.surface3, color: activeIssueId === item.id ? "#fff" : C.textMuted, fontSize: 10, fontWeight: 800, display: "flex", alignItems: "center", justifyContent: "center" }}>{idx + 1}</div>
                            <div style={{ flex: 1 }}>
                              <div style={{ fontSize: 13, fontWeight: 600, color: C.text }}>{item.title}</div>
                              <div style={{ fontSize: 10, color: C.red, fontWeight: 700, letterSpacing: 0.5 }}>{item.sourceLabel}</div>
                            </div>
                            {issueNotes[item.id] && <div style={{ fontSize: 10, color: C.green }}>📝</div>}
                          </div>
                        </div>
                      ))}
                    </div>

                    {/* Pending problems */}
                    <div className="card">
                      <h4 style={{ fontSize: 15, marginBottom: 12 }}>Problem Queue <span style={{ color: C.textMuted, fontSize: 12 }}>({pending.length})</span></h4>
                      {pending.length === 0 && (
                        <div style={{ fontSize: 13, color: C.textMuted, textAlign: "center", padding: "12px 0" }}>
                          {allItems.length === 0 ? "No problems queued. Use ⚑ Problem Solve buttons in earlier segments, or add an issue above." : "All queued problems are in focus."}
                        </div>
                      )}
                      {pending.map(item => (
                        <div key={item.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "8px 0", borderBottom: `1px solid ${C.border}` }}>
                          <div>
                            <div style={{ fontSize: 13, fontWeight: 600 }}>{item.title}</div>
                            <div style={{ fontSize: 10, color: C.textMuted }}>{item.sourceLabel}</div>
                          </div>
                          <button onClick={() => selectForFocus(item)} disabled={!canAddMore}
                            style={{ padding: "5px 12px", borderRadius: 5, border: `1px solid ${canAddMore ? C.red : C.border}`, background: canAddMore ? "rgba(230,51,41,0.1)" : C.surface2, color: canAddMore ? C.red : C.textDim, fontFamily:"'Barlow',sans-serif", fontWeight:700, fontSize:11, cursor: canAddMore ? "pointer" : "not-allowed" }}>
                            + Focus
                          </button>
                        </div>
                      ))}
                      {/* Solved this session */}
                      {solvedThisSession.length > 0 && (
                        <div style={{ marginTop: 12, paddingTop: 12, borderTop: `1px solid ${C.border}` }}>
                          <div style={{ fontSize: 11, fontWeight: 700, letterSpacing: 1, color: C.green, marginBottom: 6, textTransform: "uppercase" }}>Solved This Session</div>
                          {solvedThisSession.map(item => (
                            <div key={item.id} style={{ fontSize: 13, color: C.textMuted, textDecoration: "line-through", padding: "4px 0" }}>✓ {item.title}</div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* RIGHT: Active discussion */}
                  <div>
                    {!activeItem ? (
                      <div className="card" style={{ textAlign: "center", padding: "40px 20px" }}>
                        <div style={{ fontSize: 32, marginBottom: 12 }}>💬</div>
                        <div style={{ fontSize: 14, color: C.textMuted }}>Select a problem from the focus queue to begin discussion.</div>
                      </div>
                    ) : (
                      <div className="card fade-in" key={activeItem.id}>
                        <div style={{ background: C.red, color: "#fff", borderRadius: 6, padding: "8px 14px", marginBottom: 16, display: "inline-block", fontSize: 11, fontWeight: 800, letterSpacing: 1.5, textTransform: "uppercase" }}>
                          {activeItem.sourceLabel}
                        </div>
                        <h3 style={{ fontSize: 20, fontWeight: 700, marginBottom: 16, lineHeight: 1.3 }}>{activeItem.title}</h3>
                        <div className="field">
                          <label className="label">Discussion Notes</label>
                          <textarea
                            placeholder="Identify → Discuss → Solve. Capture the root cause, ideas discussed, and proposed solution..."
                            value={issueNotes[activeItem.id] || ""}
                            onChange={e => setIssueNotes(n => ({ ...n, [activeItem.id]: e.target.value }))}
                            style={{ minHeight: 140 }}
                          />
                        </div>
                        <div style={{ display: "flex", gap: 10, marginTop: 8 }}>
                          <button onClick={() => markSolved(activeItem)}
                            style={{ flex: 1, padding: "12px", borderRadius: 8, border: `1px solid ${C.green}`, background: "rgba(34,197,94,0.12)", color: C.green, fontFamily:"'Barlow Condensed',sans-serif", fontWeight:800, fontSize:15, cursor:"pointer", letterSpacing:1 }}>
                            ✓ SOLVED
                          </button>
                          <button onClick={() => markNotSolved(activeItem)}
                            style={{ flex: 1, padding: "12px", borderRadius: 8, border: `1px solid rgba(230,51,41,0.4)`, background: "rgba(230,51,41,0.08)", color: C.red, fontFamily:"'Barlow Condensed',sans-serif", fontWeight:800, fontSize:15, cursor:"pointer", letterSpacing:1 }}>
                            ↩ NOT SOLVED
                          </button>
                        </div>
                        <div style={{ fontSize: 11, color: C.textDim, marginTop: 10, textAlign: "center" }}>
                          "Not Solved" returns this item to the queue for a future meeting.
                        </div>
                        {/* Quick switch between focus items */}
                        {inFocus.length > 1 && (
                          <div style={{ marginTop: 16, paddingTop: 12, borderTop: `1px solid ${C.border}` }}>
                            <div style={{ fontSize: 11, color: C.textMuted, marginBottom: 8 }}>SWITCH TO:</div>
                            <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                              {inFocus.filter(f => f.id !== activeItem.id).map(f => (
                                <button key={f.id} onClick={() => setActiveIssueId(f.id)}
                                  style={{ padding: "5px 12px", borderRadius: 5, border: `1px solid ${C.border}`, background: C.surface2, color: C.textMuted, fontFamily:"'Barlow',sans-serif", fontSize:12, cursor:"pointer" }}>
                                  {f.title.length > 30 ? f.title.slice(0, 30) + "…" : f.title}
                                </button>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          })()}

          {/* CONCLUDE + RATE */}
          {activeIdx === 6 && (() => {
            const present = members.filter(m => attendance[m.id] !== false);
            const scores = Object.values(memberRatings).filter(Boolean);
            const avgPreview = scores.length > 0 ? (scores.reduce((a,b) => a+b, 0) / scores.length).toFixed(1) : null;
            const canFinish = scores.length > 0 || rating > 0;
            // For teams with no members set up, fall back to single rating
            const useMulti = present.length > 0;
            return (
              <div className="card">
                <h3 style={{ fontSize: 18, marginBottom: 4 }}>Rate This Meeting</h3>
                <div style={{ fontSize: 13, color: C.textMuted, marginBottom: 20 }}>
                  {useMulti ? "Each attendee rates the meeting 1–10. The average is saved." : "Rate the meeting on a scale of 1–10."}
                </div>

                {useMulti ? (
                  <div style={{ marginBottom: 24 }}>
                    {present.map(m => (
                      <div key={m.id} style={{ marginBottom: 16 }}>
                        <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 8, color: C.text }}>{m.name}</div>
                        <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                          {[1,2,3,4,5,6,7,8,9,10].map(n => (
                            <button key={n}
                              className={`rating-btn ${memberRatings[m.id] === n ? "sel" : ""}`}
                              style={{ width: 36, height: 36, fontSize: 13 }}
                              onClick={() => setMemberRatings(r => ({ ...r, [m.id]: n }))}>
                              {n}
                            </button>
                          ))}
                        </div>
                      </div>
                    ))}
                    {avgPreview && (
                      <div style={{ marginTop: 8, padding: "10px 14px", background: C.surface2, borderRadius: 8, fontSize: 14, color: C.text }}>
                        Current average: <strong style={{ color: parseFloat(avgPreview) >= 8 ? C.green : parseFloat(avgPreview) >= 6 ? C.yellow : C.red }}>{avgPreview}/10</strong>
                        <span style={{ color: C.textDim, fontSize: 12 }}> ({scores.length} of {present.length} rated)</span>
                      </div>
                    )}
                  </div>
                ) : (
                  <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginBottom: 24 }}>
                    {[1,2,3,4,5,6,7,8,9,10].map(n => (
                      <button key={n} className={`rating-btn ${rating === n ? "sel" : ""}`} onClick={() => setRating(n)}>{n}</button>
                    ))}
                  </div>
                )}

                <div className="field">
                  <label className="label">Closing notes</label>
                  <textarea placeholder="Key takeaways, decisions made, action items..." value={notes.conclude || ""} onChange={e => setNotes(n => ({ ...n, conclude: e.target.value }))} />
                </div>
                <button className="btn-primary" style={{ width: "100%", padding: "14px", fontSize: 15 }} onClick={finishMeeting} disabled={!canFinish}>
                  {canFinish ? `Complete Meeting & Generate Recap${avgPreview ? ` — Avg ${avgPreview}/10` : rating ? ` — ${rating}/10` : ""}` : "Rate the meeting to finish"}
                </button>
              </div>
            );
          })()}

          {/* INTRODUCTIONS / GOOD NEWS */}
          {activeIdx === 0 && (
            <div className="fade-in">
              {/* Attendance */}
              <div className="card" style={{ marginBottom: 16 }}>
                <h3 style={{ fontSize: 18, marginBottom: 4 }}>Attendance</h3>
                <div style={{ fontSize: 13, color: C.textMuted, marginBottom: 16 }}>Mark who is present for today's huddle.</div>
                {members.length === 0 && (
                  <div style={{ color: C.textMuted, fontSize: 13 }}>No team members added yet. Add them in Settings.</div>
                )}
                <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
                  {members.map(m => {
                    const status = attendance[m.id];
                    const isPresent = status !== false;
                    return (
                      <div key={m.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "12px 16px", borderRadius: 8, border: `1px solid ${isPresent ? "rgba(34,197,94,0.35)" : "rgba(230,51,41,0.25)"}`, background: isPresent ? "rgba(34,197,94,0.06)" : "rgba(230,51,41,0.06)", transition: "all 0.2s" }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                          <div style={{ width: 36, height: 36, borderRadius: "50%", background: isPresent ? "rgba(34,197,94,0.2)" : C.surface2, border: `2px solid ${isPresent ? C.green : C.border}`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14, fontWeight: 700, color: isPresent ? C.green : C.textMuted, transition: "all 0.2s" }}>
                            {m.name.charAt(0).toUpperCase()}
                          </div>
                          <div>
                            <div style={{ fontSize: 14, fontWeight: 600, color: C.text }}>{m.name}</div>
                            <div style={{ fontSize: 11, color: C.textMuted }}>{m.role}</div>
                          </div>
                        </div>
                        <div style={{ display: "flex", gap: 6 }}>
                          <button onClick={() => setAttendance(a => ({ ...a, [m.id]: true }))}
                            style={{ padding: "6px 14px", borderRadius: 6, border: `1px solid ${isPresent ? C.green : C.border}`, background: isPresent ? "rgba(34,197,94,0.2)" : C.surface2, color: isPresent ? C.green : C.textMuted, fontFamily: "'Barlow',sans-serif", fontWeight: 700, fontSize: 12, cursor: "pointer", transition: "all 0.15s" }}>
                            ✓ Present
                          </button>
                          <button onClick={() => setAttendance(a => ({ ...a, [m.id]: false }))}
                            style={{ padding: "6px 14px", borderRadius: 6, border: `1px solid ${!isPresent ? C.red : C.border}`, background: !isPresent ? "rgba(230,51,41,0.15)" : C.surface2, color: !isPresent ? C.red : C.textMuted, fontFamily: "'Barlow',sans-serif", fontWeight: 700, fontSize: 12, cursor: "pointer", transition: "all 0.15s" }}>
                            ✕ Absent
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
                {members.length > 0 && (
                  <div style={{ marginTop: 12, fontSize: 12, color: C.textMuted }}>
                    {members.filter(m => attendance[m.id] !== false).length} of {members.length} present
                  </div>
                )}
              </div>

              {/* Spotlight Selector */}
              <div className="card">
                <h3 style={{ fontSize: 18, marginBottom: 4 }}>Good News Spotlight</h3>
                <div style={{ fontSize: 13, color: C.textMuted, marginBottom: 20 }}>Randomly select a present team member to share their personal & business best from the past week.</div>

                {/* Spotlight result */}
                <div style={{ minHeight: 100, display: "flex", alignItems: "center", justifyContent: "center", marginBottom: 20 }}>
                  {!spotlight && !spinning && (
                    <div style={{ textAlign: "center", color: C.textDim, fontSize: 14 }}>Hit the button to pick someone!</div>
                  )}
                  {(spotlight || spinning) && (
                    <div style={{ textAlign: "center" }} className={spinning ? "" : "fade-in"}>
                      <div style={{ width: 72, height: 72, borderRadius: "50%", background: spinning ? C.surface2 : `rgba(230,51,41,0.15)`, border: `3px solid ${spinning ? C.border : C.red}`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 28, fontWeight: 800, color: spinning ? C.textMuted : C.red, margin: "0 auto 12px", transition: "all 0.1s", fontFamily: "'Barlow Condensed',sans-serif" }}>
                        {spotlight ? spotlight.name.charAt(0).toUpperCase() : "?"}
                      </div>
                      <div style={{ fontSize: spinning ? 18 : 24, fontWeight: 800, color: spinning ? C.textMuted : C.text, fontFamily: "'Barlow Condensed',sans-serif", letterSpacing: 1, transition: "all 0.1s" }}>
                        {spotlight ? spotlight.name : "..."}
                      </div>
                      {!spinning && spotlight && (
                        <div style={{ marginTop: 10, display: "flex", gap: 24, justifyContent: "center" }}>
                          <div style={{ textAlign: "center" }}>
                            <div style={{ fontSize: 10, fontWeight: 700, letterSpacing: 1.5, textTransform: "uppercase", color: C.red, marginBottom: 4 }}>Personal Best</div>
                            <div style={{ fontSize: 12, color: C.textMuted }}>Share with the team!</div>
                          </div>
                          <div style={{ width: 1, background: C.border }} />
                          <div style={{ textAlign: "center" }}>
                            <div style={{ fontSize: 10, fontWeight: 700, letterSpacing: 1.5, textTransform: "uppercase", color: C.red, marginBottom: 4 }}>Business Best</div>
                            <div style={{ fontSize: 12, color: C.textMuted }}>Share with the team!</div>
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>

                {(() => {
                  const present = members.filter(m => attendance[m.id] !== false);
                  const pool = present.filter(m => !alreadySelected.includes(m.id));
                  const allDone = present.length > 0 && pool.length === 0;
                  return (
                    <>
                      {allDone && (
                        <div style={{ textAlign: "center", padding: "12px", marginBottom: 12, background: "rgba(34,197,94,0.08)", border: `1px solid rgba(34,197,94,0.25)`, borderRadius: 8 }}>
                          <div style={{ fontSize: 13, color: C.green, fontWeight: 700, marginBottom: 6 }}>🎉 Everyone has been selected!</div>
                          <button onClick={() => { setAlreadySelected([]); setSpotlight(null); }}
                            style={{ fontSize: 12, padding: "6px 14px", borderRadius: 6, border: `1px solid ${C.green}`, background: "transparent", color: C.green, cursor: "pointer", fontFamily: "'Barlow',sans-serif", fontWeight: 700 }}>
                            ↺ Reset Selection Pool
                          </button>
                        </div>
                      )}
                      {!allDone && alreadySelected.length > 0 && (
                        <div style={{ fontSize: 11, color: C.textMuted, textAlign: "center", marginBottom: 10 }}>
                          {pool.length} of {present.length} remaining · <button onClick={() => { setAlreadySelected([]); setSpotlight(null); }} style={{ background: "none", border: "none", color: C.textMuted, fontSize: 11, cursor: "pointer", textDecoration: "underline", padding: 0, fontFamily: "'Barlow',sans-serif" }}>Reset</button>
                        </div>
                      )}
                      <button
                        onClick={autoSelect}
                        disabled={spinning || pool.length === 0}
                        style={{ width: "100%", padding: "14px", borderRadius: 8, border: "none", cursor: (spinning || pool.length === 0) ? "not-allowed" : "pointer", fontFamily: "'Barlow Condensed',sans-serif", fontWeight: 800, fontSize: 16, letterSpacing: 2, textTransform: "uppercase", background: (spinning || pool.length === 0) ? C.surface2 : `linear-gradient(135deg, ${C.red}, ${C.redDark})`, color: (spinning || pool.length === 0) ? C.textMuted : "#fff", transition: "all 0.2s", boxShadow: (spinning || pool.length === 0) ? "none" : `0 4px 20px rgba(230,51,41,0.3)` }}>
                        {spinning ? "Selecting..." : spotlight ? "🎲  Pick Again" : "🎲  Auto-Select Spotlight"}
                      </button>
                      {present.length === 0 && members.length > 0 && (
                        <div style={{ textAlign: "center", fontSize: 12, color: C.red, marginTop: 8 }}>Mark at least one member as present above.</div>
                      )}
                    </>
                  );
                })()}
              </div>
            </div>
          )}

          {/* Generic notes for other segments */}
          {![0,1,2,3,4,5,6].includes(activeIdx) && (
            <div className="card">
              <label className="label">Notes for this segment</label>
              <textarea placeholder="Capture notes here..." value={notes[seg.id] || ""} onChange={e => setNotes(n => ({ ...n, [seg.id]: e.target.value }))} style={{ minHeight: 120 }} />
            </div>
          )}
        </div>
      </div>
    </Layout>
  );
}

// ─── QUARTERLY TASKS ──────────────────────────────────────────────────
const OPERATORS = { gte: "≥", lte: "≤", gt: ">", lt: "<", eq: "=" };

const meetsTarget = (task) => {
  if (!task.target || !task.operator) return null; // null = no criterion set
  const raw = parseFloat(task.target);
  if (isNaN(raw)) return null;
  // We evaluate based on the current status: "done" = met, "on" = heading toward, "off" = not meeting
  // For display we just show the criterion — green if on/done, red if off
  if (task.status === "done") return true;
  if (task.status === "off") return false;
  return null; // "on track" = neutral
};

function Tasks({ company, onSave }) {
  const [tab, setTab] = useState("company");
  const [showAdd, setShowAdd] = useState(false);
  const [form, setForm] = useState({ title: "", who: "", smart: false, status: "on", huddleId: "", target: "", operator: "" });
  const tasks = company.quarterlyTasks || [];
  const huddles = company.huddles || [{ id: "huddle-1", name: "Weekly Huddle" }];
  const [huddleFilter, setHuddleFilter] = useState("all");

  const addTask = () => {
    if (!form.title.trim()) return;
    onSave({ quarterlyTasks: [...tasks, { id: uid(), ...form, createdAt: now() }] });
    setForm({ title: "", who: "", smart: false, status: "on", huddleId: "", target: "", operator: "" });
    setShowAdd(false);
  };
  const updateStatus = (id, status) => onSave({ quarterlyTasks: tasks.map(t => t.id === id ? { ...t, status } : t) });
  const deleteTask = (id) => onSave({ quarterlyTasks: tasks.filter(t => t.id !== id) });

  const companyTasks = tasks.filter(t => !t.who || t.who === "");
  const filtered = (arr) => huddleFilter === "all" ? arr : arr.filter(t => t.huddleId === huddleFilter);

  return (
    <Layout title="Quarterly Tasks" subtitle={(() => {
      const q = company.currentQuarter || "This Quarter";
      if (!company.quarterEnd) return q;
      const end = new Date(company.quarterEnd);
      const remaining = Math.max(0, Math.round((end - new Date()) / 86400000));
      return `${q} · ${remaining} day${remaining !== 1 ? "s" : ""} remaining`;
    })()}
      action={<button className="btn-primary" onClick={() => setShowAdd(true)}><Icon.plus /> Add Task</button>}>

      <div style={{ display: "flex", gap: 8, marginBottom: 12, flexWrap: "wrap", alignItems: "center" }}>
        <div style={{ display: "flex", gap: 8, flex: 1 }}>
        {["company", "individual"].map(t => (
          <button key={t} onClick={() => setTab(t)}
            style={{ padding: "8px 20px", borderRadius: 6, border: `1px solid ${C.border}`, cursor: "pointer", fontFamily: "'Barlow',sans-serif", fontWeight: 600, fontSize: 13, background: tab === t ? C.red : C.surface2, color: tab === t ? "#fff" : C.textMuted }}>
            {t === "company" ? "Company Tasks" : "Individual Tasks"}
          </button>
        ))}
        </div>
        <select value={huddleFilter} onChange={e => setHuddleFilter(e.target.value)}
          style={{ padding: "8px 12px", fontSize: 13, background: C.surface2, border: `1px solid ${C.border}`, borderRadius: 6, color: C.text }}>
          <option value="all">All Huddles</option>
          {huddles.map(h => <option key={h.id} value={h.id}>{h.name}</option>)}
        </select>
      </div>

      {tab === "company" && (
        <div className="card">
          <div style={{ display: "flex", gap: 12, marginBottom: 16 }}>
            {[["on", C.green, "On Track"], ["off", C.red, "Off Track"], ["done", C.blue, "Done"]].map(([s, c, l]) => (
              <div key={s} style={{ display: "flex", alignItems: "center", gap: 6, fontSize: 13, color: C.textMuted }}>
                <div style={{ width: 8, height: 8, borderRadius: "50%", background: c }} />{tasks.filter(t => t.status === s).length} {l}
              </div>
            ))}
          </div>
          {tasks.length === 0 && <div className="empty-state"><div style={{ fontSize: 14 }}>No tasks yet. Add your first quarterly task!</div></div>}
          <table className="table">
            {tasks.length > 0 && <thead><tr><th>Task</th><th>Who</th><th>SMART</th><th>Status</th><th></th></tr></thead>}
            <tbody>
              {tasks.map(t => (
                <tr key={t.id}>
                  <td style={{ fontWeight: 500 }}>
                    {t.title}
                    {t.operator && t.target && (
                      <span style={{ marginLeft: 8, fontSize: 11, color: C.textMuted, fontWeight: 400 }}>
                        {OPERATORS[t.operator]} {t.target}
                      </span>
                    )}
                  </td>
                  <td style={{ color: C.textMuted }}>{t.who || "—"}</td>
                  <td>{t.smart && <span className="tag-on">SMART</span>}</td>
                  <td>
                    {(() => {
                      const met = meetsTarget(t);
                      const colors = {
                        on: { bg: "rgba(34,197,94,0.12)", color: C.green, border: "rgba(34,197,94,0.3)" },
                        off: { bg: "rgba(230,51,41,0.12)", color: C.red, border: "rgba(230,51,41,0.3)" },
                        done: { bg: "rgba(59,130,246,0.12)", color: C.blue, border: "rgba(59,130,246,0.3)" },
                      };
                      // If criterion set, override on/done → green, off → red
                      const effectiveColor = met === true ? colors.done : met === false ? colors.off : colors[t.status] || colors.on;
                      return (
                        <select value={t.status} onChange={e => updateStatus(t.id, e.target.value)}
                          style={{ width: 120, padding: "6px 10px", fontSize: 12, background: effectiveColor.bg, color: effectiveColor.color, border: `1px solid ${effectiveColor.border}`, borderRadius: 6, fontWeight: 700 }}>
                          <option value="on">On Track</option>
                          <option value="off">Off Track</option>
                          <option value="done">Done</option>
                        </select>
                      );
                    })()}
                  </td>
                  <td>
                    <button className="btn-danger" style={{ padding: "6px 10px" }} onClick={() => deleteTask(t.id)}><Icon.trash /></button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {tab === "individual" && (
        <div>
          {(company.members || []).map(member => {
            const legacyTasks = (company.individualTasks || {})[member.id] || [];
            const assignedTasks = (company.quarterlyTasks || []).filter(t => t.who === member.name);
            const allTasks = [...assignedTasks, ...legacyTasks.filter(lt => !assignedTasks.find(at => at.id === lt.id))];
            return (
              <div key={member.id} className="card" style={{ marginBottom: 16 }}>
                <div style={{ fontFamily: "'Barlow Condensed',sans-serif", fontSize: 18, fontWeight: 700, marginBottom: 12 }}>{member.name}</div>
                {allTasks.map(t => {
                  const met = meetsTarget(t);
                  const statusColor = t.status === "off" || met === false ? C.red : t.status === "done" || met === true ? C.green : C.yellow;
                  const statusLabel = t.status === "done" ? "Done" : t.status === "off" ? "Off Track" : "On Track";
                  return (
                    <div key={t.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 0", borderBottom: `1px solid ${C.border}`, gap: 12 }}>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: 14, fontWeight: 500 }}>{t.title}</div>
                        {t.operator && t.target && (
                          <div style={{ fontSize: 11, color: C.textMuted, marginTop: 2 }}>{OPERATORS[t.operator]} {t.target}</div>
                        )}
                      </div>
                      <div style={{ display: "flex", alignItems: "center", gap: 8, flexShrink: 0 }}>
                        {t.smart && <span className="tag-on">SMART</span>}
                        <span style={{ fontSize: 11, fontWeight: 700, color: statusColor, background: `${statusColor}20`, border: `1px solid ${statusColor}50`, borderRadius: 20, padding: "2px 10px" }}>{statusLabel}</span>
                        <select value={t.status} onChange={e => updateStatus(t.id, e.target.value)}
                          style={{ fontSize: 11, padding: "4px 8px", background: C.surface2, border: `1px solid ${C.border}`, borderRadius: 6, color: C.textMuted }}>
                          <option value="on">On Track</option>
                          <option value="off">Off Track</option>
                          <option value="done">Done</option>
                        </select>
                      </div>
                    </div>
                  );
                })}
                {!allTasks.length && <div style={{ fontSize: 13, color: C.textMuted }}>No tasks assigned to {member.name}.</div>}
              </div>
            );
          })}
          {!(company.members || []).length && <div className="card"><div className="empty-state">Add team members in Settings to assign individual tasks.</div></div>}
        </div>
      )}

      {showAdd && (
        <div className="modal-overlay" onClick={e => e.target === e.currentTarget && setShowAdd(false)}>
          <div className="modal">
            <h3 style={{ fontSize: 20, marginBottom: 20 }}>Add Quarterly Task</h3>
            <div className="field">
              <label className="label">Task Description</label>
              <input placeholder="What needs to be accomplished this quarter?" value={form.title} onChange={e => setForm(f => ({ ...f, title: e.target.value }))} autoFocus />
            </div>
            <div className="field">
              <label className="label">Assigned To</label>
              {(company.members || []).length > 0 ? (
                <select value={form.who} onChange={e => setForm(f => ({ ...f, who: e.target.value }))}>
                  <option value="">Unassigned</option>
                  {(company.members || []).map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                  <option value="__custom">Other...</option>
                </select>
              ) : (
                <input placeholder="Name or team" value={form.who} onChange={e => setForm(f => ({ ...f, who: e.target.value }))} />
              )}
              {form.who === "__custom" && (
                <input placeholder="Enter name..." autoFocus style={{ marginTop: 8 }} onChange={e => setForm(f => ({ ...f, who: e.target.value }))} />
              )}
            </div>
            <div className="field">
              <label className="label">Initial Status</label>
              <select value={form.status} onChange={e => setForm(f => ({ ...f, status: e.target.value }))}>
                <option value="on">On Track</option>
                <option value="off">Off Track</option>
              </select>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 20 }}>
              <div className={`checkbox ${form.smart ? "checked" : ""}`} onClick={() => setForm(f => ({ ...f, smart: !f.smart }))}>
                {form.smart && <Icon.check />}
              </div>
              <span style={{ fontSize: 14 }}>This task is SMART (Specific, Measurable, Achievable, Relevant, Time-bound)</span>
            </div>
            <div className="field">
              <label className="label">Target / Success Criteria (optional)</label>
              <div style={{ display: "flex", gap: 8 }}>
                <select value={form.operator || ""} onChange={e => setForm(f => ({ ...f, operator: e.target.value }))} style={{ width: 80, flexShrink: 0 }}>
                  <option value="">—</option>
                  <option value="gte">≥</option>
                  <option value="lte">≤</option>
                  <option value="gt">&gt;</option>
                  <option value="lt">&lt;</option>
                  <option value="eq">=</option>
                </select>
                <input placeholder="e.g. 10, 95%, $50k" value={form.target || ""} onChange={e => setForm(f => ({ ...f, target: e.target.value }))} style={{ flex: 1 }} />
              </div>
              <div style={{ fontSize: 11, color: C.textMuted, marginTop: 4 }}>When a status is set, this criterion determines green/red highlighting.</div>
            </div>
            <div className="field">
              <label className="label">Assign to Huddle</label>
              <select value={form.huddleId || ""} onChange={e => setForm(f => ({ ...f, huddleId: e.target.value }))}>
                <option value="">No Huddle</option>
                {huddles.map(h => <option key={h.id} value={h.id}>{h.name}</option>)}
              </select>
            </div>
            <div style={{ display: "flex", gap: 10 }}>
              <button className="btn-primary" style={{ flex: 1 }} onClick={addTask}>Add Task</button>
              <button className="btn-secondary" onClick={() => setShowAdd(false)}>Cancel</button>
            </div>
          </div>
        </div>
      )}
    </Layout>
  );
}

// ─── SCORECARD ────────────────────────────────────────────────────────
function Scorecard({ company, onSave }) {
  const [showAdd, setShowAdd] = useState(false);
  const [newM, setNewM] = useState({ name: "", target: "", unit: "", operator: "gte", owner: "", huddleId: "" });
  const measurables = company.scorecard?.measurables || [];
  const entries = company.scorecard?.entries || {};
  const wk = weekKey();
  const members = company.members || [];
  const huddles = company.huddles || [{ id: "huddle-1", name: "Weekly Huddle" }];
  const [huddleFilter, setHuddleFilter] = useState("all");
  const filtered = huddleFilter === "all" ? measurables : measurables.filter(m => m.huddleId === huddleFilter);

  const addMeasurable = () => {
    if (!newM.name.trim()) return;
    const m = { id: uid(), ...newM };
    onSave({ scorecard: { ...company.scorecard, measurables: [...measurables, m] } });
    setNewM({ name: "", target: "", unit: "", operator: "gte", owner: "", huddleId: "" });
    setShowAdd(false);
  };

  const setEntry = (measId, val) => {
    const updated = { ...entries, [wk]: { ...(entries[wk] || {}), [measId]: val } };
    onSave({ scorecard: { ...company.scorecard, entries: updated } });
  };

  const deleteMeasurable = (id) => {
    onSave({ scorecard: { ...company.scorecard, measurables: measurables.filter(m => m.id !== id) } });
  };

  // All weeks in the current quarter
  const qStart = company.quarterStart ? new Date(company.quarterStart) : new Date(Date.now() - 12 * 7 * 86400000);
  const qEnd = company.quarterEnd ? new Date(company.quarterEnd) : new Date();
  const weeks = weeksInRange(qStart, qEnd);

  return (
    <Layout title="Scorecard" subtitle="Track your most important numbers"
      action={<button className="btn-primary" onClick={() => setShowAdd(true)}><Icon.plus /> Add Measurable</button>}>

      <div style={{ display: "flex", justifyContent: "flex-end", marginBottom: 12 }}>
        <select value={huddleFilter} onChange={e => setHuddleFilter(e.target.value)}
          style={{ padding: "6px 12px", fontSize: 13, background: C.surface2, border: `1px solid ${C.border}`, borderRadius: 6, color: C.text }}>
          <option value="all">All Huddles</option>
          {huddles.map(h => <option key={h.id} value={h.id}>{h.name}</option>)}
        </select>
      </div>

      {filtered.length === 0 ? (
        <div className="card">
          <div className="empty-state">
            <div style={{ fontSize: 14 }}>{measurables.length === 0 ? "No measurables yet. Add the numbers that matter most to your business." : "No measurables for this huddle."}</div>
            {measurables.length === 0 && <button className="btn-primary" style={{ marginTop: 16 }} onClick={() => setShowAdd(true)}>Add Your First Measurable</button>}
          </div>
        </div>
      ) : (
        <div style={{ overflowX: "auto" }}>
          <div className="card">
            <table className="table" style={{ minWidth: 700 }}>
              <thead>
                <tr>
                  <th>Measurable</th>
                  <th>Huddle</th>
                  <th>Responsible</th>
                  <th>Target</th>
                  {weeks.map(w => <th key={w} style={{ textAlign: "center" }}>{w.split("-W")[1] ? `W${w.split("-W")[1]}` : w}</th>)}
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {measurables.map(m => (
                  <tr key={m.id}>
                    <td style={{ fontWeight: 600 }}>{m.name}{m.unit && <span style={{ color: C.textMuted, fontSize: 12, marginLeft: 4 }}>({m.unit})</span>}</td>
                    <td style={{ fontSize: 12, color: C.textMuted }}>{m.huddleId ? (huddles.find(x => x.id === m.huddleId)?.name || "—") : "—"}</td>
                    <td>
                      <select value={m.owner || ""} onChange={e => {
                        onSave({ scorecard: { ...company.scorecard, measurables: measurables.map(x => x.id === m.id ? { ...x, owner: e.target.value } : x) } });
                      }} style={{ width: 130, padding: "5px 8px", fontSize: 12 }}>
                        <option value="">Unassigned</option>
                        {members.map(mem => <option key={mem.id} value={mem.name}>{mem.name}</option>)}
                      </select>
                    </td>
                    <td style={{ color: C.textMuted, whiteSpace: "nowrap" }}>
                      {m.operator && m.operator !== "gte" ? {gte:"≥",lte:"≤",gt:">",lt:"<",eq:"="}[m.operator] : "≥"} {m.target}{m.unit ? ` ${m.unit}` : ""}
                    </td>
                    {weeks.map(w => {
                      const val = entries[w]?.[m.id] || "";
                      const isCurrentWeek = w === wk;
                      const checkTarget = (val, m) => {
                      if (!val || !m.target) return null;
                      const v = parseFloat(val), t = parseFloat(m.target);
                      if (isNaN(v) || isNaN(t)) return null;
                      const op = m.operator || "gte";
                      if (op === "gte") return v >= t;
                      if (op === "lte") return v <= t;
                      if (op === "gt")  return v > t;
                      if (op === "lt")  return v < t;
                      if (op === "eq")  return v === t;
                      return null;
                    };
                    const onTarget = checkTarget(val, m);
                      return (
                        <td key={w} style={{ textAlign: "center" }}>
                          {isCurrentWeek ? (
                            <input value={val} onChange={e => setEntry(m.id, e.target.value)}
                              style={{ width: 70, textAlign: "center", padding: "6px 8px", fontSize: 13, border: `1px solid ${C.red}` }} />
                          ) : (
                            <span style={{ color: val ? (onTarget === true ? C.green : onTarget === false ? C.red : C.textMuted) : C.textDim, fontWeight: val ? 700 : 400 }}>
                              {val || "—"}
                            </span>
                          )}
                        </td>
                      );
                    })}
                    <td>
                      <button className="btn-danger" style={{ padding: "6px 10px" }} onClick={() => deleteMeasurable(m.id)}><Icon.trash /></button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {showAdd && (
        <div className="modal-overlay" onClick={e => e.target === e.currentTarget && setShowAdd(false)}>
          <div className="modal">
            <h3 style={{ fontSize: 20, marginBottom: 20 }}>Add Measurable</h3>
            <div className="field">
              <label className="label">Measurable Name</label>
              <input placeholder="e.g. Revenue, Closed Jobs, NPS Score..." value={newM.name} onChange={e => setNewM(m => ({ ...m, name: e.target.value }))} autoFocus />
            </div>
            <div className="field">
              <label className="label">Weekly Target</label>
              <div style={{ display: "flex", gap: 8 }}>
                <select value={newM.operator || "gte"} onChange={e => setNewM(m => ({ ...m, operator: e.target.value }))}
                  style={{ width: 90, flexShrink: 0 }}>
                  <option value="gte">≥ (at least)</option>
                  <option value="lte">≤ (at most)</option>
                  <option value="gt">&gt; (more than)</option>
                  <option value="lt">&lt; (less than)</option>
                  <option value="eq">= (exactly)</option>
                </select>
                <input placeholder="e.g. 50000" value={newM.target} onChange={e => setNewM(m => ({ ...m, target: e.target.value }))} style={{ flex: 1 }} />
                <input placeholder="unit ($, jobs, %)" value={newM.unit} onChange={e => setNewM(m => ({ ...m, unit: e.target.value }))} style={{ width: 110, flexShrink: 0 }} />
              </div>
              <div style={{ fontSize: 11, color: C.textMuted, marginTop: 5 }}>
                e.g. <strong>≥ 50000 $</strong> for revenue, <strong>≤ 1000 $</strong> for fuel costs
              </div>
            </div>
            <div className="field">
              <label className="label">Who's Responsible</label>
              <select value={newM.owner} onChange={e => setNewM(m => ({ ...m, owner: e.target.value }))}>
                <option value="">Unassigned</option>
                {members.map(mem => <option key={mem.id} value={mem.name}>{mem.name}</option>)}
              </select>
            </div>
            <div className="field">
              <label className="label">Assign to Huddle</label>
              <select value={newM.huddleId || ""} onChange={e => setNewM(m => ({ ...m, huddleId: e.target.value }))}>
                <option value="">No Huddle</option>
                {huddles.map(h => <option key={h.id} value={h.id}>{h.name}</option>)}
              </select>
            </div>
            <div style={{ display: "flex", gap: 10 }}>
              <button className="btn-primary" style={{ flex: 1 }} onClick={addMeasurable}>Add</button>
              <button className="btn-secondary" onClick={() => setShowAdd(false)}>Cancel</button>
            </div>
          </div>
        </div>
      )}
    </Layout>
  );
}

// ─── HEADLINES ────────────────────────────────────────────────────────
function Headlines({ company, onSave }) {
  const [form, setForm] = useState({ type: "Customer", text: "", huddleId: "" });
  const headlines = company.headlines || [];
  const huddles = company.huddles || [{ id: "huddle-1", name: "Weekly Huddle" }];
  const [huddleFilter, setHuddleFilter] = useState("all");
  const [showReviewed, setShowReviewed] = useState(false);

  const add = () => {
    if (!form.text.trim()) return;
    onSave({ headlines: [...headlines, { id: uid(), ...form, date: now() }] });
    setForm(f => ({ ...f, text: "" }));
  };
  const del = (id) => onSave({ headlines: headlines.filter(h => h.id !== id) });
  const markReviewed = (id) => onSave({ headlines: headlines.map(h => h.id === id ? { ...h, reviewed: true, reviewedAt: now() } : h) });
  const unmarkReviewed = (id) => onSave({ headlines: headlines.map(h => h.id === id ? { ...h, reviewed: false, reviewedAt: null } : h) });

  const applyHuddleFilter = (arr) => huddleFilter === "all" ? arr : arr.filter(h => h.huddleId === huddleFilter);
  const active = applyHuddleFilter(headlines.filter(h => !h.reviewed));
  const reviewed = applyHuddleFilter(headlines.filter(h => h.reviewed));

  const HeadlineRow = ({ h, isReviewed }) => (
    <div key={h.id} style={{ display: "flex", alignItems: "flex-start", justifyContent: "space-between", padding: "12px 0", borderBottom: `1px solid ${C.border}`, gap: 8, opacity: isReviewed ? 0.6 : 1 }}>
      <div style={{ flex: 1 }}>
        <div style={{ marginBottom: 4 }}>
          <span className="chip" style={{ marginRight: 8, fontSize: 10, background: h.type === "Customer" ? "rgba(59,130,246,0.15)" : "rgba(34,197,94,0.1)", borderColor: h.type === "Customer" ? "rgba(59,130,246,0.3)" : "rgba(34,197,94,0.2)", color: h.type === "Customer" ? C.blue : C.green }}>{h.type}</span>
          {h.huddleId && <span className="chip" style={{ marginRight: 8, fontSize: 10 }}>{huddles.find(x => x.id === h.huddleId)?.name || ""}</span>}
          {isReviewed && <span className="chip" style={{ fontSize: 10, background: "rgba(34,197,94,0.1)", borderColor: "rgba(34,197,94,0.3)", color: C.green }}>Reviewed</span>}
        </div>
        <span style={{ fontSize: 14, textDecoration: isReviewed ? "line-through" : "none" }}>{h.text}</span>
        <div style={{ fontSize: 11, color: C.textDim, marginTop: 4 }}>{dateStr(new Date(h.date))}{isReviewed && h.reviewedAt ? ` · Reviewed ${dateStr(new Date(h.reviewedAt))}` : ""}</div>
      </div>
      <div style={{ display: "flex", gap: 6, flexShrink: 0 }}>
        {!isReviewed && (
          <button className="btn-ghost" style={{ fontSize: 11, color: C.green, border: `1px solid rgba(34,197,94,0.3)`, padding: "4px 10px", borderRadius: 5 }} onClick={() => markReviewed(h.id)}>✓ Reviewed</button>
        )}
        {isReviewed && (
          <button className="btn-ghost" style={{ fontSize: 11, padding: "4px 10px", borderRadius: 5 }} onClick={() => unmarkReviewed(h.id)}>Reopen</button>
        )}
        <button className="btn-ghost" style={{ padding: "4px 8px", color: C.textDim }} onClick={() => del(h.id)}><Icon.trash /></button>
      </div>
    </div>
  );

  return (
    <Layout title="Headlines" subtitle="Customer & Employee news from the week">
      <div style={{ maxWidth: 700 }}>
        <div className="card" style={{ marginBottom: 20 }}>
          <h3 style={{ fontSize: 18, marginBottom: 16 }}>Add Headline</h3>
          <div style={{ display: "flex", gap: 10, flexWrap: "wrap" }}>
            <select value={form.type} onChange={e => setForm(f => ({ ...f, type: e.target.value }))} style={{ width: 140 }}>
              <option>Customer</option><option>Employee</option>
            </select>
            <select value={form.huddleId || ""} onChange={e => setForm(f => ({ ...f, huddleId: e.target.value }))} style={{ width: 150 }}>
              <option value="">No Huddle</option>
              {huddles.map(h => <option key={h.id} value={h.id}>{h.name}</option>)}
            </select>
            <input placeholder="What happened this week?" value={form.text} onChange={e => setForm(f => ({ ...f, text: e.target.value }))} onKeyDown={e => e.key === "Enter" && add()} style={{ flex: 1 }} />
            <button className="btn-primary" style={{ padding: "10px 20px" }} onClick={add}>Add</button>
          </div>
        </div>

        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 }}>
          <span style={{ fontSize: 14, color: C.textMuted }}>{active.length} active · {reviewed.length} reviewed</span>
          <select value={huddleFilter} onChange={e => setHuddleFilter(e.target.value)}
            style={{ padding: "6px 12px", fontSize: 13, background: C.surface2, border: `1px solid ${C.border}`, borderRadius: 6, color: C.text }}>
            <option value="all">All Huddles</option>
            {huddles.map(h => <option key={h.id} value={h.id}>{h.name}</option>)}
          </select>
        </div>

        <div className="card" style={{ marginBottom: 16 }}>
          <h3 style={{ fontSize: 16, marginBottom: 12 }}>Active ({active.length})</h3>
          {active.length === 0 && <div style={{ fontSize: 13, color: C.textMuted, padding: "8px 0" }}>No active headlines. All caught up!</div>}
          {[...active].reverse().map(h => <HeadlineRow key={h.id} h={h} isReviewed={false} />)}
        </div>

        {reviewed.length > 0 && (
          <div className="card">
            <button className="btn-ghost" style={{ width: "100%", textAlign: "left", padding: "4px 0", marginBottom: showReviewed ? 12 : 0 }}
              onClick={() => setShowReviewed(s => !s)}>
              <span style={{ fontSize: 16, fontWeight: 700 }}>Reviewed ({reviewed.length})</span>
              <span style={{ marginLeft: 8, color: C.textMuted }}>{showReviewed ? "▲ Hide" : "▼ Show"}</span>
            </button>
            {showReviewed && [...reviewed].reverse().map(h => <HeadlineRow key={h.id} h={h} isReviewed={true} />)}
          </div>
        )}
      </div>
    </Layout>
  );
}

// ─── ISSUES ───────────────────────────────────────────────────────────
function Issues({ company, onSave }) {
  const [showAdd, setShowAdd] = useState(false);
  const [form, setForm] = useState({ title: "", priority: "2", notes: "", huddleId: "" });
  const issues = company.issues || [];
  const huddles = company.huddles || [{ id: "huddle-1", name: "Weekly Huddle" }];
  const [huddleFilter, setHuddleFilter] = useState("all");

  const add = () => {
    if (!form.title.trim()) return;
    onSave({ issues: [...issues, { id: uid(), ...form, status: "open", createdAt: now() }] });
    setForm({ title: "", priority: "2", notes: "", huddleId: "" });
    setShowAdd(false);
  };
  const resolve = (id) => onSave({ issues: issues.map(i => i.id === id ? { ...i, status: "resolved" } : i) });
  const del = (id) => onSave({ issues: issues.filter(i => i.id !== id) });

  const allOpen = issues.filter(i => i.status !== "resolved");
  const allResolved = issues.filter(i => i.status === "resolved");
  const open = (huddleFilter === "all" ? allOpen : allOpen.filter(i => i.huddleId === huddleFilter)).sort((a, b) => a.priority - b.priority);
  const resolved = huddleFilter === "all" ? allResolved : allResolved.filter(i => i.huddleId === huddleFilter);

  return (
    <Layout title="Issues" subtitle="Identify, Discuss & Solve"
      action={<button className="btn-primary" onClick={() => setShowAdd(true)}><Icon.plus /> Add Issue</button>}>

      <div style={{ maxWidth: 700 }}>
        <div style={{ display: "flex", justifyContent: "flex-end", marginBottom: 12 }}>
          <select value={huddleFilter} onChange={e => setHuddleFilter(e.target.value)}
            style={{ padding: "6px 12px", fontSize: 13, background: C.surface2, border: `1px solid ${C.border}`, borderRadius: 6, color: C.text }}>
            <option value="all">All Huddles</option>
            {huddles.map(h => <option key={h.id} value={h.id}>{h.name}</option>)}
          </select>
        </div>
        {open.length === 0 && <div className="card" style={{ marginBottom: 16 }}><div className="empty-state"><div style={{ fontSize: 14 }}>No open issues. </div></div></div>}

        {open.length > 0 && (
          <div className="card" style={{ marginBottom: 20 }}>
            <h3 style={{ fontSize: 18, marginBottom: 16 }}>Open Issues ({open.length})</h3>
            {open.map(iss => (
              <div key={iss.id} style={{ padding: "14px 0", borderBottom: `1px solid ${C.border}` }}>
                <div style={{ display: "flex", alignItems: "flex-start", justifyContent: "space-between" }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 4, flexWrap: "wrap" }}>
                      <span style={{ fontSize: 11, fontWeight: 700, color: iss.priority == 1 ? C.red : iss.priority == 2 ? C.yellow : C.blue, background: iss.priority == 1 ? "rgba(230,51,41,0.1)" : iss.priority == 2 ? "rgba(234,179,8,0.1)" : "rgba(59,130,246,0.1)", padding: "2px 8px", borderRadius: 4 }}>
                        PRIORITY {iss.priority}
                      </span>
                      {iss.huddleId && <span className="chip" style={{ fontSize: 10 }}>{huddles.find(x => x.id === iss.huddleId)?.name || ""}</span>}
                      <span style={{ fontSize: 14, fontWeight: 600 }}>{iss.title}</span>
                    </div>
                    {iss.notes && <div style={{ fontSize: 13, color: C.textMuted }}>{iss.notes}</div>}
                    <div style={{ fontSize: 11, color: C.textDim, marginTop: 4 }}>{dateStr(new Date(iss.createdAt))}</div>
                  </div>
                  <div style={{ display: "flex", gap: 6 }}>
                    <button className="btn-ghost" style={{ fontSize: 12, color: C.green }} onClick={() => resolve(iss.id)}>✓ Resolve</button>
                    <button className="btn-ghost" style={{ padding: "4px 8px", color: C.textDim }} onClick={() => del(iss.id)}><Icon.trash /></button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}

        {resolved.length > 0 && (
          <div className="card">
            <h3 style={{ fontSize: 18, marginBottom: 12, color: C.textMuted }}>Resolved ({resolved.length})</h3>
            {resolved.slice(-5).reverse().map(iss => (
              <div key={iss.id} style={{ padding: "8px 0", borderBottom: `1px solid ${C.border}`, opacity: 0.6 }}>
                <span style={{ fontSize: 13, textDecoration: "line-through", color: C.textMuted }}>{iss.title}</span>
              </div>
            ))}
          </div>
        )}
      </div>

      {showAdd && (
        <div className="modal-overlay" onClick={e => e.target === e.currentTarget && setShowAdd(false)}>
          <div className="modal">
            <h3 style={{ fontSize: 20, marginBottom: 20 }}>Add Issue</h3>
            <div className="field">
              <label className="label">Issue</label>
              <input placeholder="Describe the issue..." value={form.title} onChange={e => setForm(f => ({ ...f, title: e.target.value }))} autoFocus />
            </div>
            <div className="field">
              <label className="label">Priority</label>
              <select value={form.priority} onChange={e => setForm(f => ({ ...f, priority: e.target.value }))}>
                <option value="1">1 — Critical</option>
                <option value="2">2 — Important</option>
                <option value="3">3 — Minor</option>
              </select>
            </div>
            <div className="field">
              <label className="label">Notes (optional)</label>
              <textarea placeholder="Additional context..." value={form.notes} onChange={e => setForm(f => ({ ...f, notes: e.target.value }))} />
            </div>
            <div className="field">
              <label className="label">Assign to Huddle</label>
              <select value={form.huddleId || ""} onChange={e => setForm(f => ({ ...f, huddleId: e.target.value }))}>
                <option value="">No Huddle</option>
                {huddles.map(h => <option key={h.id} value={h.id}>{h.name}</option>)}
              </select>
            </div>
            <div style={{ display: "flex", gap: 10 }}>
              <button className="btn-primary" style={{ flex: 1 }} onClick={add}>Add Issue</button>
              <button className="btn-secondary" onClick={() => setShowAdd(false)}>Cancel</button>
            </div>
          </div>
        </div>
      )}
    </Layout>
  );
}

// ─── TO-DOS ───────────────────────────────────────────────────────────
function Todos({ company, onSave }) {
  const todoDueDefault = () => new Date(Date.now() + 7 * 86400000).toISOString().slice(0,10);
  const [form, setForm] = useState({ title: "", assignees: [], dueDate: todoDueDefault(), huddleId: "" });
  const todos = company.todos || [];
  const huddles = company.huddles || [{ id: "huddle-1", name: "Weekly Huddle" }];
  const [huddleFilter, setHuddleFilter] = useState("all");

  const add = () => {
    if (!form.title.trim()) return;
    onSave({ todos: [...todos, { id: uid(), title: form.title, assignees: form.assignees, dueDate: form.dueDate, huddleId: form.huddleId, done: false, createdAt: now() }] });
    setForm({ title: "", assignees: [], dueDate: todoDueDefault(), huddleId: "" });
  };
  const toggle = (id) => onSave({ todos: todos.map(t => t.id === id ? { ...t, done: !t.done } : t) });
  const del = (id) => onSave({ todos: todos.filter(t => t.id !== id) });

  const allPending = todos.filter(t => !t.done);
  const allDone = todos.filter(t => t.done);
  const pending = huddleFilter === "all" ? allPending : allPending.filter(t => t.huddleId === huddleFilter);
  const done = huddleFilter === "all" ? allDone : allDone.filter(t => t.huddleId === huddleFilter);

  return (
    <Layout title="To-Dos" subtitle="Weekly action items">
      <div style={{ maxWidth: 700 }}>
        <div className="card" style={{ marginBottom: 20 }}>
          <h3 style={{ fontSize: 18, marginBottom: 16 }}>Add To-Do</h3>
          <div style={{ display: "flex", gap: 10, flexWrap: "wrap", marginBottom: (company.members||[]).length ? 10 : 0 }}>
            <input placeholder="What needs to happen?" value={form.title} onChange={e => setForm(f => ({ ...f, title: e.target.value }))} onKeyDown={e => e.key === "Enter" && add()} style={{ flex: 2, minWidth: 200 }} />
            <input type="date" value={form.dueDate} onChange={e => setForm(f => ({ ...f, dueDate: e.target.value }))} style={{ flex: 1, minWidth: 130 }} />
            <select value={form.huddleId || ""} onChange={e => setForm(f => ({ ...f, huddleId: e.target.value }))} style={{ flex: 1, minWidth: 140 }}>
              <option value="">No Huddle</option>
              {huddles.map(h => <option key={h.id} value={h.id}>{h.name}</option>)}
            </select>
            <button className="btn-primary" style={{ padding: "10px 20px" }} onClick={add}>Add</button>
          </div>
          {(company.members || []).length > 0 && (
            <div style={{ display: "flex", flexWrap: "wrap", gap: 6, alignItems: "center" }}>
              <span style={{ fontSize: 12, color: C.textMuted, marginRight: 2 }}>Assign to:</span>
              {(company.members || []).map(m => {
                const sel = (form.assignees || []).includes(m.name);
                return (
                  <button key={m.id} onClick={() => setForm(f => ({ ...f, assignees: sel ? f.assignees.filter(a => a !== m.name) : [...(f.assignees||[]), m.name] }))}
                    style={{ padding: "4px 12px", borderRadius: 20, fontSize: 12, fontWeight: 600, cursor: "pointer", fontFamily: "'Barlow',sans-serif", transition: "all 0.15s",
                      background: sel ? "rgba(230,51,41,0.15)" : C.surface2,
                      color: sel ? C.red : C.textMuted,
                      border: `1px solid ${sel ? "rgba(230,51,41,0.4)" : C.border}` }}>
                    {sel ? "✓ " : ""}{m.name}
                  </button>
                );
              })}
              <button onClick={() => {
                const allNames = (company.members||[]).map(m => m.name);
                const allSel = allNames.every(n => (form.assignees||[]).includes(n));
                setForm(f => ({ ...f, assignees: allSel ? [] : allNames }));
              }} style={{ padding: "4px 12px", borderRadius: 20, fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: "'Barlow',sans-serif", background: C.surface2, color: C.textMuted, border: `1px solid ${C.border}` }}>
                {(company.members||[]).every(m => (form.assignees||[]).includes(m.name)) ? "✓ Everyone" : "Everyone"}
              </button>
              {(form.assignees||[]).length > 0 && (
                <span style={{ fontSize: 11, color: C.textMuted, marginLeft: 4 }}>
                  → {form.assignees.join(", ")}
                </span>
              )}
            </div>
          )}
        </div>

        <div style={{ display: "flex", justifyContent: "flex-end", marginBottom: 12 }}>
          <select value={huddleFilter} onChange={e => setHuddleFilter(e.target.value)}
            style={{ padding: "6px 12px", fontSize: 13, background: C.surface2, border: `1px solid ${C.border}`, borderRadius: 6, color: C.text }}>
            <option value="all">All Huddles</option>
            {huddles.map(h => <option key={h.id} value={h.id}>{h.name}</option>)}
          </select>
        </div>

        <div className="card" style={{ marginBottom: 16 }}>
          <h3 style={{ fontSize: 18, marginBottom: 12 }}>Pending ({pending.length})</h3>
          {pending.length === 0 && <div style={{ fontSize: 13, color: C.textMuted }}>All clear! No pending to-dos.</div>}
          {pending.map(t => {
            const isOverdue = t.dueDate && new Date(t.dueDate) < new Date();
            return (
              <div key={t.id} style={{ display: "flex", alignItems: "center", gap: 12, padding: "10px 0", borderBottom: `1px solid ${C.border}` }}>
                <div className={`checkbox ${t.done ? "checked" : ""}`} onClick={() => toggle(t.id)}>{t.done && <Icon.check />}</div>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 14, fontWeight: 500 }}>{t.title}</div>
                  <div style={{ fontSize: 11, color: isOverdue ? C.red : C.textMuted, marginTop: 2 }}>
                    {getAssignees(t).length > 0 && <span>{getAssignees(t).join(", ")}</span>}
                    {getAssignees(t).length > 0 && t.dueDate && <span> · </span>}
                    {t.dueDate && <span style={{ fontWeight: isOverdue ? 700 : 400 }}>{isOverdue ? "⚠ Overdue — " : "Due "}{dateStr(new Date(t.dueDate))}</span>}
                    {t.huddleId && <span> · {huddles.find(x => x.id === t.huddleId)?.name || ""}</span>}
                  </div>
                </div>
                <button className="btn-ghost" style={{ padding: "4px 8px", color: C.textDim }} onClick={() => del(t.id)}><Icon.trash /></button>
              </div>
            );
          })}
        </div>

        {done.length > 0 && (
          <div className="card">
            <h3 style={{ fontSize: 18, marginBottom: 12, color: C.textMuted }}>Completed ({done.length})</h3>
            {done.slice(-8).reverse().map(t => (
              <div key={t.id} style={{ display: "flex", alignItems: "center", gap: 12, padding: "8px 0", borderBottom: `1px solid ${C.border}`, opacity: 0.6 }}>
                <div className="checkbox checked"><Icon.check /></div>
                <div style={{ flex: 1, textDecoration: "line-through", fontSize: 14, color: C.textMuted }}>{t.title}</div>
                <button className="btn-ghost" style={{ padding: "4px 8px", color: C.textDim }} onClick={() => del(t.id)}><Icon.trash /></button>
              </div>
            ))}
          </div>
        )}
      </div>
    </Layout>
  );
}

// ─── ORG CHART ────────────────────────────────────────────────────────
function PreviewBox({ label, name, note, color }) {
  color = color || C.red;
  return (
    <div style={{ background: C.surface, border: `2px solid ${color}`, borderRadius: 8, padding: "10px 14px", minWidth: 140, maxWidth: 200, flexShrink: 0 }}>
      <div style={{ fontFamily: "'Barlow Condensed',sans-serif", fontSize: 14, fontWeight: 800, color, marginBottom: 2 }}>{label}</div>
      {name && <div style={{ fontSize: 13, fontWeight: 600, marginBottom: 2 }}>{name}</div>}
      {note && <div style={{ fontSize: 11, color: C.textMuted, lineHeight: 1.4 }}>{note}</div>}
    </div>
  );
}

const DEFAULT_CHART_LEADERS = [
  { id: "l1", title: "Dreamer (Visionary)", name: "", responsibilities: "Big Ideas, Strategic Thinking, Culture, R&D" },
  { id: "l2", title: "Doer (Integrator)", name: "", responsibilities: "Fulfillment, Business Plan, Lead, Bridge Building" },
];
const DEFAULT_CHART_DEPTS = [
  { id: "d1", label: "Sales / Marketing", color: "blue",   staff: [] },
  { id: "d2", label: "Operations",        color: "yellow", staff: [] },
  { id: "d3", label: "Finance",           color: "green",  staff: [] },
];
const DEPT_COLORS = ["blue","yellow","green","red","purple"];
const deptColor = (c) => ({ blue: C.blue, yellow: C.yellow, green: C.green, red: C.red, purple: "#a855f7" })[c] || C.blue;

function migrateChart(raw) {
  // Migrate old dreamer/doer/salesRoles etc. format to new leaders/departments format
  if (raw.leaders) return raw; // already migrated
  const leaders = [
    { id: "l1", title: "Dreamer (Visionary)", name: raw.dreamer || "", responsibilities: "Big Ideas, Strategic Thinking, Culture, R&D" },
    { id: "l2", title: "Doer (Integrator)",   name: raw.doer   || "", responsibilities: "Fulfillment, Business Plan, Lead, Bridge Building" },
  ];
  const deptMap = [
    { id: "d1", label: "Sales / Marketing", color: "blue",   key: "salesRoles" },
    { id: "d2", label: "Operations",        color: "yellow", key: "opsRoles" },
    { id: "d3", label: "Finance",           color: "green",  key: "financeRoles" },
  ];
  const departments = deptMap.map(d => ({
    id: d.id, label: d.label, color: d.color,
    staff: (raw[d.key] || []).flatMap(r => r.members.map(name => ({ id: uid(), title: r.role, name }))),
  }));
  return { ...raw, leaders, departments };
}

function OrgChart({ company, onSave, orgChartId, orgChartName }) {
  const orgCharts = company.orgCharts || [{ id: "org-1", name: "Responsibility Chart" }];
  const rawObj = orgCharts.find(o => o.id === orgChartId) || orgCharts[0] || {};
  const [chart, setChart] = useState(() => migrateChart(rawObj));
  const [saved, setSaved] = useState(false);

  useEffect(() => {
    const raw = (company.orgCharts || []).find(x => x.id === orgChartId) || {};
    setChart(migrateChart(raw));
  }, [orgChartId]);

  const save = () => {
    const updated = orgCharts.map(o => o.id === orgChartId ? { ...chart, id: orgChartId, name: orgChartName } : o);
    onSave({ orgCharts: updated });
    setSaved(true); setTimeout(() => setSaved(false), 2000);
  };

  // Leaders
  const setLeader = (id, k, v) => setChart(c => ({ ...c, leaders: (c.leaders || DEFAULT_CHART_LEADERS).map(l => l.id === id ? { ...l, [k]: v } : l) }));
  const addLeader = () => setChart(c => ({ ...c, leaders: [...(c.leaders || DEFAULT_CHART_LEADERS), { id: uid(), title: "New Role", name: "", responsibilities: "" }] }));
  const removeLeader = (id) => setChart(c => ({ ...c, leaders: (c.leaders || []).filter(l => l.id !== id) }));

  // Departments
  const setDept = (id, k, v) => setChart(c => ({ ...c, departments: (c.departments || DEFAULT_CHART_DEPTS).map(d => d.id === id ? { ...d, [k]: v } : d) }));
  const addDept = () => setChart(c => ({ ...c, departments: [...(c.departments || DEFAULT_CHART_DEPTS), { id: uid(), label: "New Department", color: DEPT_COLORS[(c.departments||[]).length % DEPT_COLORS.length], headName: "", headTitle: "", staff: [] }] }));
  const removeDept = (id) => setChart(c => ({ ...c, departments: (c.departments || []).filter(d => d.id !== id) }));

  // Staff
  const addStaff = (deptId) => setChart(c => ({ ...c, departments: (c.departments||[]).map(d => d.id === deptId ? { ...d, staff: [...(d.staff||[]), { id: uid(), title: "", name: "" }] } : d) }));
  const setStaff = (deptId, staffId, k, v) => setChart(c => ({ ...c, departments: (c.departments||[]).map(d => d.id === deptId ? { ...d, staff: (d.staff||[]).map(s => s.id === staffId ? { ...s, [k]: v } : s) } : d) }));
  const removeStaff = (deptId, staffId) => setChart(c => ({ ...c, departments: (c.departments||[]).map(d => d.id === deptId ? { ...d, staff: (d.staff||[]).filter(s => s.id !== staffId) } : d) }));

  const leaders = chart.leaders || DEFAULT_CHART_LEADERS;
  const departments = chart.departments || DEFAULT_CHART_DEPTS;

  // PreviewBox defined at module level to avoid remount

  return (
    <Layout title={orgChartName} subtitle="Define roles and accountability"
      action={<button className="btn-primary" onClick={save}>{saved ? "✓ Saved" : "Save Chart"}</button>}>

      {/* ── LEADERSHIP TIER ── */}
      <div className="card" style={{ marginBottom: 16 }}>
        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 16 }}>
          <h3 style={{ fontSize: 18, margin: 0 }}>Leadership</h3>
          <button className="btn-secondary" style={{ fontSize: 12, padding: "6px 12px" }} onClick={addLeader}>+ Add Role</button>
        </div>
        <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
          {leaders.map((l, i) => (
            <div key={l.id} style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10, alignItems: "start", padding: "12px 14px", background: C.surface2, borderRadius: 8, border: `1px solid ${C.border}` }}>
              <div className="field" style={{ margin: 0 }}>
                <label className="label">Title</label>
                <input value={l.title} onChange={e => setLeader(l.id, "title", e.target.value)} placeholder="e.g. CEO, Visionary" />
              </div>
              <div className="field" style={{ margin: 0 }}>
                <label className="label">Person</label>
                {(company.members||[]).length > 0 ? (
                  <select value={l.name} onChange={e => setLeader(l.id, "name", e.target.value)}>
                    <option value="">— Select —</option>
                    {(company.members||[]).map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                    <option value="__custom">Other...</option>
                  </select>
                ) : (
                  <input value={l.name} onChange={e => setLeader(l.id, "name", e.target.value)} placeholder="Name" />
                )}
                {l.name === "__custom" && <input style={{ marginTop: 6 }} placeholder="Enter name..." onChange={e => setLeader(l.id, "name", e.target.value)} />}
              </div>
              <div className="field" style={{ margin: 0 }}>
                <label className="label">Responsibilities</label>
                <input value={l.responsibilities} onChange={e => setLeader(l.id, "responsibilities", e.target.value)} placeholder="Key responsibilities..." />
              </div>
              {leaders.length > 1 && (
                <button className="btn-danger" style={{ padding: "6px 10px", marginTop: 20 }} onClick={() => removeLeader(l.id)}><Icon.trash /></button>
              )}
            </div>
          ))}
        </div>
      </div>

      {/* ── DEPARTMENTS ── */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(280px, 1fr))", gap: 16, marginBottom: 16 }}>
        {departments.map(dept => (
          <div key={dept.id} className="card" style={{ borderTop: `3px solid ${deptColor(dept.color)}` }}>
            {/* Dept name + color + delete */}
            <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 12 }}>
              <input value={dept.label} onChange={e => setDept(dept.id, "label", e.target.value)}
                style={{ flex: 1, fontFamily: "'Barlow Condensed',sans-serif", fontSize: 17, fontWeight: 800, background: "transparent", border: "none", borderBottom: `1px solid ${C.border}`, color: C.text, padding: "2px 0", outline: "none" }} />
              <select value={dept.color} onChange={e => setDept(dept.id, "color", e.target.value)}
                style={{ width: 80, fontSize: 11, padding: "4px 6px", background: C.surface2, border: `1px solid ${C.border}`, borderRadius: 5, color: C.text }}>
                <option value="blue">Blue</option>
                <option value="yellow">Yellow</option>
                <option value="green">Green</option>
                <option value="red">Red</option>
                <option value="purple">Purple</option>
              </select>
              <button className="btn-danger" style={{ padding: "4px 8px", fontSize: 11 }} onClick={() => removeDept(dept.id)}><Icon.trash /></button>
            </div>

            {/* Department Head */}
            <div style={{ padding: "10px 12px", marginBottom: 12, background: `${deptColor(dept.color)}18`, border: `1px solid ${deptColor(dept.color)}40`, borderRadius: 7 }}>
              <div style={{ fontSize: 10, fontWeight: 700, letterSpacing: 1, textTransform: "uppercase", color: deptColor(dept.color), marginBottom: 8 }}>Department Head</div>
              <div style={{ display: "flex", gap: 8 }}>
                <input value={dept.headTitle || ""} onChange={e => setDept(dept.id, "headTitle", e.target.value)}
                  placeholder="Title (e.g. Director)" style={{ flex: 1, fontSize: 12, padding: "6px 8px" }} />
                {(company.members||[]).length > 0 ? (
                  <select value={dept.headName || ""} onChange={e => setDept(dept.id, "headName", e.target.value)} style={{ flex: 1, fontSize: 12, padding: "6px 8px" }}>
                    <option value="">— Select —</option>
                    {(company.members||[]).map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                  </select>
                ) : (
                  <input value={dept.headName || ""} onChange={e => setDept(dept.id, "headName", e.target.value)}
                    placeholder="Name" style={{ flex: 1, fontSize: 12, padding: "6px 8px" }} />
                )}
              </div>
            </div>

            {/* Staff rows */}
            {(dept.staff || []).length > 0 && (
              <div style={{ fontSize: 10, fontWeight: 700, letterSpacing: 1, textTransform: "uppercase", color: C.textMuted, marginBottom: 8 }}>Staff</div>
            )}
            {(dept.staff || []).map(s => (
              <div key={s.id} style={{ display: "flex", gap: 8, marginBottom: 8, alignItems: "center" }}>
                <input value={s.title} onChange={e => setStaff(dept.id, s.id, "title", e.target.value)}
                  placeholder="Role" style={{ flex: 1, fontSize: 12, padding: "6px 8px" }} />
                {(company.members||[]).length > 0 ? (
                  <select value={s.name} onChange={e => setStaff(dept.id, s.id, "name", e.target.value)} style={{ flex: 1, fontSize: 12, padding: "6px 8px" }}>
                    <option value="">— Name —</option>
                    {(company.members||[]).map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                  </select>
                ) : (
                  <input value={s.name} onChange={e => setStaff(dept.id, s.id, "name", e.target.value)}
                    placeholder="Name" style={{ flex: 1, fontSize: 12, padding: "6px 8px" }} />
                )}
                <button className="btn-ghost" style={{ padding: "4px 8px", color: C.textDim, flexShrink: 0 }} onClick={() => removeStaff(dept.id, s.id)}><Icon.trash /></button>
              </div>
            ))}
            <button className="btn-secondary" style={{ width: "100%", fontSize: 12, padding: "7px", marginTop: 4 }} onClick={() => addStaff(dept.id)}>
              + Add Staff
            </button>
          </div>
        ))}
        <div style={{ display: "flex", alignItems: "center", justifyContent: "center" }}>
          <button className="btn-secondary" style={{ padding: "12px 20px", fontSize: 13 }} onClick={addDept}>+ Add Department</button>
        </div>
      </div>

      {/* ── VISUAL PREVIEW ── */}
      <div className="card" style={{ marginTop: 4, overflowX: "auto" }}>
        <h3 style={{ fontSize: 18, marginBottom: 20 }}>Chart Preview</h3>
        <div style={{ display: "flex", flexDirection: "column", alignItems: "center", minWidth: 400 }}>
          {/* Leaders chain */}
          {leaders.map((l, i) => (
            <React.Fragment key={l.id}>
              <PreviewBox label={l.title} name={l.name} note={l.responsibilities} color={C.red} />
              {i < leaders.length - 1 && <div style={{ width: 2, height: 20, background: C.border }} />}
            </React.Fragment>
          ))}
          {/* Connector to departments */}
          {departments.length > 0 && (
            <>
              <div style={{ width: 2, height: 20, background: C.border }} />
              <div style={{ display: "flex", alignItems: "flex-start", gap: 16, position: "relative", flexWrap: "wrap", justifyContent: "center" }}>
                {departments.length > 1 && (
                  <div style={{ position: "absolute", top: 0, left: "10%", right: "10%", height: 2, background: C.border, zIndex: 0 }} />
                )}
                {departments.map(dept => (
                  <div key={dept.id} style={{ display: "flex", flexDirection: "column", alignItems: "center", zIndex: 1 }}>
                    <PreviewBox
                      label={dept.label}
                      name={dept.headName ? `${dept.headTitle ? dept.headTitle + ": " : ""}${dept.headName}` : ""}
                      note={(dept.staff||[]).map(s => `${s.title}${s.name ? `: ${s.name}` : ""}`).join(" · ") || undefined}
                      color={deptColor(dept.color)}
                    />
                  </div>
                ))}
              </div>
            </>
          )}
        </div>
      </div>
    </Layout>
  );
}

// ─── MEETING HISTORY ──────────────────────────────────────────────────
function MeetingHistory({ company }) {
  const meetings = [...(company.meetings || [])].reverse();

  return (
    <Layout title="Meeting History" subtitle={`${meetings.length} meetings on record`}>
      {meetings.length === 0 ? (
        <div className="card"><div className="empty-state"><div>No meetings yet. Run your first Weekly Huddle to see history here.</div></div></div>
      ) : (
        <div style={{ maxWidth: 700 }}>
          {meetings.map(m => (
            <div key={m.id} className="card" style={{ marginBottom: 16 }}>
              <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 }}>
                <div>
                  <div style={{ fontFamily: "'Barlow Condensed',sans-serif", fontSize: 20, fontWeight: 700 }}>{dateStr(new Date(m.date))}</div>
                  <div style={{ fontSize: 12, color: C.textMuted }}>Duration: ~{m.totalMinutes || "—"} minutes</div>
                </div>
                <div style={{ textAlign: "center" }}>
                  <div style={{ fontSize: 32, fontWeight: 800, color: m.rating >= 8 ? C.green : m.rating >= 6 ? C.yellow : C.red, fontFamily: "'Barlow Condensed',sans-serif" }}>{m.rating}</div>
                  <div style={{ fontSize: 11, color: C.textMuted }}>/ 10</div>
                </div>
              </div>
              {m.notes?.conclude && (
                <div style={{ fontSize: 13, color: C.textMuted, background: C.surface2, borderRadius: 6, padding: "10px 14px" }}>{m.notes.conclude}</div>
              )}
            </div>
          ))}
        </div>
      )}
    </Layout>
  );
}

// ─── SETTINGS ────────────────────────────────────────────────────────
function Settings({ company, onSave }) {
  const [newMember, setNewMember] = useState({ name: "", email: "", role: "member" });
  const [quarterLabel, setQuarterLabel] = useState(company.currentQuarter || "");
  const [quarterStart, setQuarterStart] = useState(company.quarterStart || new Date().toISOString().slice(0,10));
  const [quarterEnd, setQuarterEnd] = useState(company.quarterEnd || new Date(Date.now() + 90 * 86400000).toISOString().slice(0,10));
  const [yearGoal, setYearGoal] = useState(company.yearGoal || {});
  const [annualGoals, setAnnualGoals] = useState(company.annualGoals || [{ id: "goal-1", name: "Annual Goal", futureDate: "", revenue: "", profit: "" }]);
  const [newGoalName, setNewGoalName] = useState("");
  const [companyName, setCompanyName] = useState(company.name || "");
  const [newHuddleName, setNewHuddleName] = useState("");
  const [newNavName, setNewNavName] = useState("");
  const [newOrgName, setNewOrgName] = useState("");
  const huddles = company.huddles || [{ id: "huddle-1", name: "Weekly Huddle" }];
  const navigators = company.navigators || [{ id: "nav-1", name: "Navigator" }];
  const orgCharts = company.orgCharts || [{ id: "org-1", name: "Responsibility Chart" }];

  const addHuddle = () => {
    if (!newHuddleName.trim()) return;
    onSave({ huddles: [...huddles, { id: "huddle-" + uid(), name: newHuddleName.trim() }] });
    setNewHuddleName("");
  };
  const renameHuddle = (id, name) => onSave({ huddles: huddles.map(h => h.id === id ? { ...h, name } : h) });
  const deleteHuddle = (id) => { if (huddles.length <= 1) return; onSave({ huddles: huddles.filter(h => h.id !== id) }); };

  const addNavigator = () => {
    if (!newNavName.trim()) return;
    const newNav = { id: "nav-" + uid(), name: newNavName.trim(), coreValues: ["","",""], purpose: "", avenue: "", targetMarket: "", different: "", proof: "", promise: "", futureDate: "", revenue: "", profit: "", whatLooksLike: "", majorMotivator: "" };
    onSave({ navigators: [...navigators, newNav] });
    setNewNavName("");
  };
  const renameNavigator = (id, name) => onSave({ navigators: navigators.map(n => n.id === id ? { ...n, name } : n) });
  const deleteNavigator = (id) => { if (navigators.length <= 1) return; onSave({ navigators: navigators.filter(n => n.id !== id) }); };

  const addOrgChart = () => {
    if (!newOrgName.trim()) return;
    const newOrg = { id: "org-" + uid(), name: newOrgName.trim(), dreamer: "", doer: "", salesRoles: [{ role: "Sales/Mktg", members: [""] }], opsRoles: [{ role: "Operations", members: [""] }], financeRoles: [{ role: "Finance", members: [""] }] };
    onSave({ orgCharts: [...orgCharts, newOrg] });
    setNewOrgName("");
  };
  const renameOrgChart = (id, name) => onSave({ orgCharts: orgCharts.map(o => o.id === id ? { ...o, name } : o) });
  const deleteOrgChart = (id) => { if (orgCharts.length <= 1) return; onSave({ orgCharts: orgCharts.filter(o => o.id !== id) }); };

  const addMember = () => {
    if (!newMember.name.trim()) return;
    const m = { id: uid(), ...newMember };
    onSave({ members: [...(company.members || []), m] });
    setNewMember({ name: "", email: "", role: "member" });
  };
  const delMember = (id) => onSave({ members: company.members.filter(m => m.id !== id) });

  const renameMember = (id, newName) => {
    const oldName = (company.members || []).find(m => m.id === id)?.name;
    if (!oldName || oldName === newName) return;
    const rename = (name) => name === oldName ? newName : name;
    // Cascade rename across all data that references member name
    const updates = {
      members: company.members.map(m => m.id === id ? { ...m, name: newName } : m),
      quarterlyTasks: (company.quarterlyTasks || []).map(t => ({ ...t, who: rename(t.who) })),
      todos: (company.todos || []).map(t => ({
        ...t,
        assignee: t.assignee === oldName ? newName : t.assignee,
        assignees: (t.assignees || []).map(a => rename(a)),
      })),
      scorecard: {
        ...company.scorecard,
        measurables: (company.scorecard?.measurables || []).map(m => ({ ...m, owner: rename(m.owner) })),
      },
    };
    onSave(updates);
  };

  return (
    <Layout title="Settings" subtitle={company.name}>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill,minmax(300px,1fr))", gap: 20, maxWidth: 900 }}>
        <div>
          <div className="card" style={{ marginBottom: 20 }}>
            <h3 style={{ fontSize: 18, marginBottom: 16 }}>Company Name</h3>
            <div className="field">
              <input placeholder="Your Company Name" value={companyName} onChange={e => setCompanyName(e.target.value)} onKeyDown={e => e.key === "Enter" && onSave({ name: companyName })} />
            </div>
            <button className="btn-primary" onClick={() => onSave({ name: companyName })}>Save Name</button>
          </div>
          <div className="card" style={{ marginBottom: 20 }}>
            <h3 style={{ fontSize: 18, marginBottom: 4 }}>Huddles</h3>
            <div style={{ fontSize: 12, color: C.textMuted, marginBottom: 16 }}>Assign team members to each huddle. Members only appear in their assigned huddle's attendance & spotlight.</div>
            {huddles.map(h => {
              const hMemberIds = h.memberIds || [];
              const toggleMember = (mid) => {
                const next = hMemberIds.includes(mid) ? hMemberIds.filter(id => id !== mid) : [...hMemberIds, mid];
                onSave({ huddles: huddles.map(x => x.id === h.id ? { ...x, memberIds: next } : x) });
              };
              const allMembers = company.members || [];
              return (
                <div key={h.id} style={{ marginBottom: 16, paddingBottom: 16, borderBottom: `1px solid ${C.border}` }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: allMembers.length ? 10 : 0 }}>
                    <input value={h.name} onChange={e => renameHuddle(h.id, e.target.value)} style={{ flex: 1, background: "transparent", border: "none", borderBottom: `1px solid ${C.border}`, color: C.text, fontSize: 14, padding: "4px 0", outline: "none" }} />
                    {huddles.length > 1 && <button className="btn-danger" style={{ padding: "4px 8px", fontSize: 12 }} onClick={() => deleteHuddle(h.id)}><Icon.trash /></button>}
                  </div>
                  {allMembers.length === 0 && (
                    <div style={{ fontSize: 11, color: C.textDim, fontStyle: "italic" }}>Add team members in the Team Members section below.</div>
                  )}
                  {allMembers.length > 0 && (
                    <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
                      {allMembers.map(m => {
                        const assigned = hMemberIds.includes(m.id);
                        return (
                          <button key={m.id} onClick={() => toggleMember(m.id)}
                            style={{ padding: "4px 12px", borderRadius: 20, fontSize: 12, fontWeight: 600, cursor: "pointer", fontFamily: "'Barlow',sans-serif", transition: "all 0.15s",
                              background: assigned ? `rgba(230,51,41,0.15)` : C.surface2,
                              color: assigned ? C.red : C.textMuted,
                              border: `1px solid ${assigned ? "rgba(230,51,41,0.4)" : C.border}` }}>
                            {assigned ? "✓ " : ""}{m.name}
                          </button>
                        );
                      })}
                    </div>
                  )}
                  {allMembers.length > 0 && hMemberIds.length === 0 && (
                    <div style={{ fontSize: 11, color: C.textDim, marginTop: 6, fontStyle: "italic" }}>No members assigned — all team members will appear.</div>
                  )}
                </div>
              );
            })}
            <div style={{ display: "flex", gap: 8, marginTop: 4 }}>
              <input placeholder="New huddle name..." value={newHuddleName} onChange={e => setNewHuddleName(e.target.value)} onKeyDown={e => e.key === "Enter" && addHuddle()} style={{ flex: 1 }} />
              <button className="btn-primary" style={{ padding: "8px 14px" }} onClick={addHuddle}>+ Add</button>
            </div>
          </div>

          <div className="card" style={{ marginBottom: 20 }}>
            <h3 style={{ fontSize: 18, marginBottom: 16 }}>Navigators</h3>
            {navigators.map(n => (
              <div key={n.id} style={{ display: "flex", alignItems: "center", gap: 8, padding: "6px 0", borderBottom: `1px solid ${C.border}` }}>
                <input value={n.name} onChange={e => renameNavigator(n.id, e.target.value)} style={{ flex: 1, background: "transparent", border: "none", borderBottom: `1px solid ${C.border}`, color: C.text, fontSize: 14, padding: "4px 0", outline: "none" }} />
                {navigators.length > 1 && <button className="btn-danger" style={{ padding: "4px 8px", fontSize: 12 }} onClick={() => deleteNavigator(n.id)}><Icon.trash /></button>}
              </div>
            ))}
            <div style={{ display: "flex", gap: 8, marginTop: 12 }}>
              <input placeholder="New navigator name..." value={newNavName} onChange={e => setNewNavName(e.target.value)} onKeyDown={e => e.key === "Enter" && addNavigator()} style={{ flex: 1 }} />
              <button className="btn-primary" style={{ padding: "8px 14px" }} onClick={addNavigator}>+ Add</button>
            </div>
          </div>

          <div className="card" style={{ marginBottom: 20 }}>
            <h3 style={{ fontSize: 18, marginBottom: 16 }}>Responsibility Charts</h3>
            {orgCharts.map(o => (
              <div key={o.id} style={{ display: "flex", alignItems: "center", gap: 8, padding: "6px 0", borderBottom: `1px solid ${C.border}` }}>
                <input value={o.name} onChange={e => renameOrgChart(o.id, e.target.value)} style={{ flex: 1, background: "transparent", border: "none", borderBottom: `1px solid ${C.border}`, color: C.text, fontSize: 14, padding: "4px 0", outline: "none" }} />
                {orgCharts.length > 1 && <button className="btn-danger" style={{ padding: "4px 8px", fontSize: 12 }} onClick={() => deleteOrgChart(o.id)}><Icon.trash /></button>}
              </div>
            ))}
            <div style={{ display: "flex", gap: 8, marginTop: 12 }}>
              <input placeholder="New chart name..." value={newOrgName} onChange={e => setNewOrgName(e.target.value)} onKeyDown={e => e.key === "Enter" && addOrgChart()} style={{ flex: 1 }} />
              <button className="btn-primary" style={{ padding: "8px 14px" }} onClick={addOrgChart}>+ Add</button>
            </div>
          </div>

          <div className="card" style={{ marginBottom: 20 }}>
            <h3 style={{ fontSize: 18, marginBottom: 16 }}>Team Members</h3>
            {(company.members || []).map(m => (
              <div key={m.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 0", borderBottom: `1px solid ${C.border}`, gap: 8 }}>
                <div style={{ flex: 1, minWidth: 0 }}>
                  <input
                    defaultValue={m.name}
                    onBlur={e => renameMember(m.id, e.target.value.trim())}
                    onKeyDown={e => e.key === "Enter" && e.target.blur()}
                    style={{ fontSize: 14, fontWeight: 600, color: C.text, background: "transparent", border: "none", borderBottom: `1px solid ${C.border}`, padding: "2px 0", outline: "none", width: "100%", fontFamily: "'Barlow',sans-serif" }}
                  />
                  <div style={{ fontSize: 11, color: C.textMuted, marginTop: 2 }}>{m.email}{m.email && m.role ? " · " : ""}{m.role}</div>
                </div>
                <button className="btn-danger" style={{ padding: "6px 10px", flexShrink: 0 }} onClick={() => delMember(m.id)}><Icon.trash /></button>
              </div>
            ))}
            {(company.members||[]).length > 0 && (
              <div style={{ fontSize: 11, color: C.textDim, marginTop: 8, fontStyle: "italic" }}>Click a name to edit it. Changes cascade to all tasks and to-dos.</div>
            )}
            <div style={{ marginTop: 16 }}>
              <h4 style={{ fontSize: 15, marginBottom: 10 }}>Add Team Member</h4>
              <div className="field">
                <input placeholder="Full name" value={newMember.name} onChange={e => setNewMember(m => ({ ...m, name: e.target.value }))} />
              </div>
              <div className="grid2">
                <input placeholder="Email" value={newMember.email} onChange={e => setNewMember(m => ({ ...m, email: e.target.value }))} />
                <select value={newMember.role} onChange={e => setNewMember(m => ({ ...m, role: e.target.value }))}>
                  <option value="owner">Owner</option>
                  <option value="admin">Admin</option>
                  <option value="member">Member</option>
                </select>
              </div>
              <button className="btn-primary" style={{ marginTop: 10, width: "100%" }} onClick={addMember}>Add Member</button>
            </div>
          </div>
        </div>

        <div>
          <div className="card" style={{ marginBottom: 20 }}>
            <h3 style={{ fontSize: 18, marginBottom: 16 }}>Current Quarter</h3>
            <div className="field">
              <label className="label">Quarter Label</label>
              <input placeholder="e.g. Q1 2025 or Spring Sprint" value={quarterLabel} onChange={e => setQuarterLabel(e.target.value)} />
            </div>
            <div className="grid2" style={{ marginBottom: 12 }}>
              <div className="field">
                <label className="label">Start Date</label>
                <input type="date" value={quarterStart} onChange={e => setQuarterStart(e.target.value)} />
              </div>
              <div className="field">
                <label className="label">End Date</label>
                <input type="date" value={quarterEnd} onChange={e => setQuarterEnd(e.target.value)} />
              </div>
            </div>
            {quarterStart && quarterEnd && (() => {
              const s = new Date(quarterStart), e2 = new Date(quarterEnd), t = new Date();
              const total = Math.max(1, Math.round((e2 - s) / 86400000));
              const remaining = Math.max(0, Math.round((e2 - t) / 86400000));
              const elapsed = Math.min(100, Math.round(((t - s) / 86400000 / total) * 100));
              return (
                <div style={{ fontSize: 12, color: C.textMuted, marginBottom: 12, padding: "8px 12px", background: C.surface2, borderRadius: 6 }}>
                  <span style={{ color: C.text, fontWeight: 600 }}>{total} days total</span>
                  {" · "}
                  <span style={{ color: remaining <= 14 ? C.red : remaining <= 30 ? C.yellow : C.green, fontWeight: 600 }}>{remaining} days remaining</span>
                  {" · "}
                  {elapsed}% elapsed
                </div>
              );
            })()}
            <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
              <button className="btn-primary" onClick={() => onSave({ currentQuarter: quarterLabel, quarterStart, quarterEnd })}>Save Quarter</button>
              <button className="btn-ghost" style={{ fontSize: 12 }} onClick={() => {
                const s = new Date().toISOString().slice(0,10);
                const e2 = new Date(Date.now() + 90 * 86400000).toISOString().slice(0,10);
                setQuarterStart(s); setQuarterEnd(e2);
              }}>Reset to 90 days from today</button>
            </div>
          </div>

          <div className="card">
            <h3 style={{ fontSize: 18, marginBottom: 4 }}>Annual Goals</h3>
            <div style={{ fontSize: 12, color: C.textMuted, marginBottom: 16 }}>Set goals for each company or division. Each can have its own label, target date, revenue, and profit goal.</div>

            {annualGoals.map((g, i) => (
              <div key={g.id} style={{ marginBottom: 20, paddingBottom: 20, borderBottom: `1px solid ${C.border}` }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 12 }}>
                  <input
                    value={g.name}
                    onChange={e => {
                      const updated = annualGoals.map(x => x.id === g.id ? { ...x, name: e.target.value } : x);
                      setAnnualGoals(updated);
                      onSave({ annualGoals: updated });
                    }}
                    style={{ flex: 1, background: "transparent", border: "none", borderBottom: `1px solid ${C.border}`, color: C.text, fontSize: 15, fontWeight: 700, padding: "4px 0", outline: "none", fontFamily: "'Barlow Condensed',sans-serif", letterSpacing: 0.5 }}
                  />
                  {annualGoals.length > 1 && (
                    <button className="btn-danger" style={{ padding: "4px 8px", fontSize: 12 }} onClick={() => {
                      const updated = annualGoals.filter(x => x.id !== g.id);
                      setAnnualGoals(updated);
                      onSave({ annualGoals: updated });
                    }}><Icon.trash /></button>
                  )}
                </div>
                <div className="field">
                  <label className="label">Target Date</label>
                  <input type="date" value={g.futureDate || ""} onChange={e => {
                    const updated = annualGoals.map(x => x.id === g.id ? { ...x, futureDate: e.target.value } : x);
                    setAnnualGoals(updated);
                    onSave({ annualGoals: updated });
                  }} />
                </div>
                <div className="grid2">
                  <div className="field">
                    <label className="label">Revenue Goal</label>
                    <input placeholder="$1,000,000" value={g.revenue || ""} onChange={e => {
                      const updated = annualGoals.map(x => x.id === g.id ? { ...x, revenue: e.target.value } : x);
                      setAnnualGoals(updated);
                      onSave({ annualGoals: updated });
                    }} />
                  </div>
                  <div className="field">
                    <label className="label">Profit Goal</label>
                    <input placeholder="$200,000" value={g.profit || ""} onChange={e => {
                      const updated = annualGoals.map(x => x.id === g.id ? { ...x, profit: e.target.value } : x);
                      setAnnualGoals(updated);
                      onSave({ annualGoals: updated });
                    }} />
                  </div>
                </div>
              </div>
            ))}

            <div style={{ display: "flex", gap: 8, marginTop: 4 }}>
              <input placeholder="New goal label (e.g. Subsidiary A)..." value={newGoalName} onChange={e => setNewGoalName(e.target.value)}
                onKeyDown={e => {
                  if (e.key === "Enter" && newGoalName.trim()) {
                    const updated = [...annualGoals, { id: "goal-" + uid(), name: newGoalName.trim(), futureDate: "", revenue: "", profit: "" }];
                    setAnnualGoals(updated);
                    onSave({ annualGoals: updated });
                    setNewGoalName("");
                  }
                }}
                style={{ flex: 1 }} />
              <button className="btn-primary" style={{ padding: "8px 14px" }} onClick={() => {
                if (!newGoalName.trim()) return;
                const updated = [...annualGoals, { id: "goal-" + uid(), name: newGoalName.trim(), futureDate: "", revenue: "", profit: "" }];
                setAnnualGoals(updated);
                onSave({ annualGoals: updated });
                setNewGoalName("");
              }}>+ Add</button>
            </div>
          </div>
        </div>
      </div>
    </Layout>
  );
}

// ─── HISTORICAL QUARTERS ──────────────────────────────────────────────
function QuarterHistory({ company }) {
  const history = [...(company.quarterHistory || [])].reverse();
  const [expanded, setExpanded] = useState(history[0]?.quarter || null);

  if (history.length === 0) {
    return (
      <Layout title="Historical Quarters" subtitle="A record of every quarter's work">
        <div className="card">
          <div className="empty-state">
            <div style={{ fontSize: 14 }}>No quarter history yet. Complete a Weekly Huddle meeting to start archiving quarterly data.</div>
          </div>
        </div>
      </Layout>
    );
  }

  return (
    <Layout title="Historical Quarters" subtitle={`${history.length} quarter${history.length !== 1 ? "s" : ""} archived`}>
      <div style={{ maxWidth: 900 }}>
        {history.map(q => {
          const isOpen = expanded === q.quarter;
          const avgRating = q.meetingRatings?.length
            ? (q.meetingRatings.reduce((a, r) => a + r.rating, 0) / q.meetingRatings.length).toFixed(1)
            : "—";
          const solved = q.solvedProblems || [];
          const tasks = q.tasks || [];
          const todos = q.todos || [];

          return (
            <div key={q.quarter} className="card" style={{ marginBottom: 16 }}>
              {/* Quarter header */}
              <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", cursor: "pointer" }}
                onClick={() => setExpanded(isOpen ? null : q.quarter)}>
                <div style={{ display: "flex", alignItems: "center", gap: 16 }}>
                  <div style={{ background: C.red, color: "#fff", fontFamily: "'Barlow Condensed',sans-serif", fontWeight: 800, fontSize: 14, letterSpacing: 2, padding: "6px 14px", borderRadius: 6 }}>{q.quarter}</div>
                  <div style={{ display: "flex", gap: 20 }}>
                    <span style={{ fontSize: 12, color: C.textMuted }}><span style={{ color: C.text, fontWeight: 700 }}>{tasks.length}</span> Tasks</span>
                    <span style={{ fontSize: 12, color: C.textMuted }}><span style={{ color: C.text, fontWeight: 700 }}>{todos.length}</span> To-Dos</span>
                    <span style={{ fontSize: 12, color: C.textMuted }}><span style={{ color: C.green, fontWeight: 700 }}>{solved.length}</span> Solved</span>
                    <span style={{ fontSize: 12, color: C.textMuted }}>Avg Rating: <span style={{ color: avgRating >= 8 ? C.green : avgRating >= 6 ? C.yellow : C.red, fontWeight: 700 }}>{avgRating}</span></span>
                  </div>
                </div>
                <span style={{ color: C.textMuted, fontSize: 18, transform: isOpen ? "rotate(90deg)" : "none", transition: "transform 0.2s" }}>›</span>
              </div>

              {isOpen && (
                <div className="fade-in" style={{ marginTop: 20 }}>

                  {/* Tasks table */}
                  <div style={{ marginBottom: 24 }}>
                    <div style={{ fontSize: 13, fontWeight: 800, letterSpacing: 1.5, textTransform: "uppercase", color: C.red, marginBottom: 10 }}>Quarterly Tasks</div>
                    {tasks.length === 0 ? <div style={{ fontSize: 13, color: C.textMuted }}>No tasks recorded.</div> : (
                      <table className="table">
                        <thead><tr><th>Task</th><th>Assigned To</th><th>Final Status</th></tr></thead>
                        <tbody>
                          {tasks.map((t, i) => (
                            <tr key={i}>
                              <td>{t.title}</td>
                              <td style={{ color: C.textMuted }}>{t.who || "—"}</td>
                              <td><span className={t.status === "done" ? "tag-done" : t.status === "on" ? "tag-on" : "tag-off"}>{t.status === "done" ? "Completed" : t.status === "on" ? "On Track" : "Off Track"}</span></td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    )}
                  </div>

                  {/* To-Dos table */}
                  <div style={{ marginBottom: 24 }}>
                    <div style={{ fontSize: 13, fontWeight: 800, letterSpacing: 1.5, textTransform: "uppercase", color: C.red, marginBottom: 10 }}>To-Dos</div>
                    {todos.length === 0 ? <div style={{ fontSize: 13, color: C.textMuted }}>No to-dos recorded.</div> : (
                      <table className="table">
                        <thead><tr><th>To-Do</th><th>Assigned To</th><th>Status</th></tr></thead>
                        <tbody>
                          {todos.map((t, i) => (
                            <tr key={i}>
                              <td>{t.title}</td>
                              <td style={{ color: C.textMuted }}>{t.assignee || "—"}</td>
                              <td><span className={t.done ? "tag-done" : "tag-off"}>{t.done ? "Done" : "Incomplete"}</span></td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    )}
                  </div>

                  {/* Solved Problems table */}
                  <div style={{ marginBottom: 24 }}>
                    <div style={{ fontSize: 13, fontWeight: 800, letterSpacing: 1.5, textTransform: "uppercase", color: C.green, marginBottom: 10 }}>Problems Solved</div>
                    {solved.length === 0 ? <div style={{ fontSize: 13, color: C.textMuted }}>No problems marked solved this quarter.</div> : (
                      <table className="table">
                        <thead><tr><th>Problem</th><th>Source</th><th>Notes</th><th>Solved</th></tr></thead>
                        <tbody>
                          {solved.map((s, i) => (
                            <tr key={i}>
                              <td style={{ fontWeight: 600 }}>{s.title}</td>
                              <td style={{ color: C.textMuted }}>{s.sourceLabel || "—"}</td>
                              <td style={{ color: C.textMuted, fontSize: 12, maxWidth: 280 }}>{s.notes || "—"}</td>
                              <td style={{ color: C.textMuted, fontSize: 12, whiteSpace: "nowrap" }}>{s.solvedAt ? dateStr(new Date(s.solvedAt)) : "—"}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    )}
                  </div>

                  {/* Meeting ratings */}
                  {q.meetingRatings?.length > 0 && (
                    <div>
                      <div style={{ fontSize: 13, fontWeight: 800, letterSpacing: 1.5, textTransform: "uppercase", color: C.textMuted, marginBottom: 10 }}>Meeting Ratings This Quarter</div>
                      <table className="table">
                        <thead><tr><th>Date</th><th>Rating</th></tr></thead>
                        <tbody>
                          {q.meetingRatings.map((r, i) => (
                            <tr key={i}>
                              <td style={{ color: C.textMuted }}>{dateStr(new Date(r.date))}</td>
                              <td><span style={{ fontWeight: 800, color: r.rating >= 8 ? C.green : r.rating >= 6 ? C.yellow : C.red }}>{r.rating}/10</span></td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </Layout>
  );
}

// ─── STYLE INJECTOR ──────────────────────────────────────────────────
function GlobalStyles({ theme }) {
  useEffect(() => {
    const id = "vast-global-styles";
    let el = document.getElementById(id);
    if (!el) {
      el = document.createElement("style");
      el.id = id;
      document.head.appendChild(el);
    }
    el.textContent = makeSTYLE(C);
    document.body.style.background = C.bg;
    document.body.style.color = C.text;
  }, [theme]);
  return null;
}

// ─── MAIN APP ─────────────────────────────────────────────────────────
function VASTApp() {
  const [company, setCompanyState] = useState(null);
  const [view, setView] = useState("dashboard");
  const [mobileOpen, setMobileOpen] = useState(false);
  const [theme, setTheme] = useState(() => localStorage.getItem("vast-theme") || "dark");
  const [sidebarCollapsed, setSidebarCollapsed] = useState(() => localStorage.getItem("vast-sidebar-collapsed") === "1");

  // Reassign global C before every render so all children pick up current theme
  C = theme === "light" ? LIGHT_THEME : DARK_THEME;

  const toggleTheme = () => {
    const next = theme === "dark" ? "light" : "dark";
    localStorage.setItem("vast-theme", next);
    setTheme(next);
  };

  useEffect(() => {
    const init = async () => {
      // Migrate any old localStorage data to cloud (no-op if already done)
      let raw = await migrateLocalStorageToCloud();

      // Load from Memberstack cloud (falls back to local cache if needed)
      if (!raw) raw = await loadCompany();

      if (raw) {
        // Migrate existing data that's missing new array fields
        if (!raw.huddles) raw.huddles = [{ id: "huddle-1", name: "Weekly Huddle" }];
        if (!raw.navigators) raw.navigators = [{ id: "nav-1", name: "Navigator", coreValues: raw.navigator?.coreValues || ["","",""], purpose: raw.navigator?.purpose || "", avenue: raw.navigator?.avenue || "", targetMarket: raw.navigator?.targetMarket || "", different: raw.navigator?.different || "", proof: raw.navigator?.proof || "", promise: raw.navigator?.promise || "", futureDate: raw.navigator?.futureDate || "", revenue: raw.navigator?.revenue || "", profit: raw.navigator?.profit || "", whatLooksLike: raw.navigator?.whatLooksLike || "", majorMotivator: raw.navigator?.majorMotivator || "" }];
        if (!raw.orgCharts) raw.orgCharts = [{ id: "org-1", name: "Responsibility Chart", ...(raw.orgChart || { dreamer: "", doer: "", salesRoles: [{ role: "Sales/Mktg", members: [""] }], opsRoles: [{ role: "Operations", members: [""] }], financeRoles: [{ role: "Finance", members: [""] }] }) }];
        if (!raw.annualGoals) raw.annualGoals = [{ id: "goal-1", name: "Annual Goal", futureDate: raw.yearGoal?.futureDate || "", revenue: raw.yearGoal?.revenue || "", profit: raw.yearGoal?.profit || "" }];
        if (!raw.quarterStart) raw.quarterStart = new Date().toISOString().slice(0,10);
        if (!raw.quarterEnd) raw.quarterEnd = new Date(Date.now() + 90 * 86400000).toISOString().slice(0,10);
      }
      setCompanyState(raw || defaultCompany('My Company', 'myco'));
    };
    init();
  }, []);

  const handleSave = useCallback((updates) => {
    if (!company) return;
    const updated = { ...company, ...updates };
    setCompanyState(updated);
    saveCompany(updated);
  }, [company]);

  if (!company) return (
    <><GlobalStyles theme={theme} />
    <div style={{ minHeight: "100vh", background: C.bg, display: "flex", alignItems: "center", justifyContent: "center" }}>
      <div style={{ textAlign: "center" }}>
        <VASTLogo size="lg" />
        <div style={{ marginTop: 16, color: C.textMuted, fontSize: 14 }}>Loading...</div>
      </div>
    </div></>
  );

  const viewProps = { company, onSave: handleSave };

  return (
    <SidebarCollapsedContext.Provider value={sidebarCollapsed}>
    <div style={{ minHeight: "100vh", background: C.bg }}>
      <GlobalStyles theme={theme} />
      <MobileMenuContext.Provider value={() => setMobileOpen(true)}>
      <Sidebar view={view} setView={v => { setView(v); setMobileOpen(false); }} company={company} theme={theme} toggleTheme={toggleTheme} mobileOpen={mobileOpen} setMobileOpen={setMobileOpen} collapsed={sidebarCollapsed} setCollapsed={setSidebarCollapsed} />
      {view === "dashboard" && <Dashboard {...viewProps} setView={setView} />}
      {view.startsWith("navigator:") && (() => {
        const nid = view.slice(10);
        const nObj = (company.navigators || []).find(n => n.id === nid) || { id: nid, name: "Navigator" };
        return <Navigator {...viewProps} navigatorId={nid} navigatorName={nObj.name} />;
      })()}
      {view.startsWith("huddle:") && (() => {
        const hid = view.slice(7);
        const hObj = (company.huddles || []).find(h => h.id === hid) || { id: hid, name: "Weekly Huddle" };
        return <WeeklyHuddle {...viewProps} huddleId={hid} huddleName={hObj.name} />;
      })()}
      {view === "tasks" && <Tasks {...viewProps} />}
      {view === "scorecard" && <Scorecard {...viewProps} />}
      {view === "headlines" && <Headlines {...viewProps} />}
      {view === "issues" && <Issues {...viewProps} />}
      {view === "todos" && <Todos {...viewProps} />}
      {view.startsWith("orgchart:") && (() => {
        const oid = view.slice(9);
        const oObj = (company.orgCharts || []).find(o => o.id === oid) || { id: oid, name: "Responsibility Chart" };
        return <OrgChart {...viewProps} orgChartId={oid} orgChartName={oObj.name} />;
      })()}
      {view === "history" && <MeetingHistory {...viewProps} />}
      {view === "quarterhistory" && <QuarterHistory {...viewProps} />}
      {view === "settings" && <Settings {...viewProps} />}
      </MobileMenuContext.Provider>
    </div>
    </SidebarCollapsedContext.Provider>
  );
}



const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(VASTApp));

  </script>
  <script>
    // Hide loading screen once React has mounted
    window.addEventListener('load', function() {
      setTimeout(function() {
        var loader = document.getElementById('vast-loading');
        if (loader) { loader.style.opacity = '0'; setTimeout(function(){ loader.remove(); }, 400); }
      }, 800);
    });
  </script>
</body>
</html>
